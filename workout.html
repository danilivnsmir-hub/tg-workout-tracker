<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Трекер тренировок</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0f1115; --card: #171a21; --muted: #9aa4b2; --text: #e6e9ef;
      --acc: #4f8cff; --line: #2a2f3a; --card2: #131720; --danger: #ef4444;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text); margin: 0; padding-bottom: 72px;
    }
    header {
      background: var(--card); padding: 12px; position: sticky; top: 0; z-index: 5;
      border-bottom: 1px solid var(--line);
    }
    h1 { margin: 0; font-size: 18px; }
    .muted { color: var(--muted); font-size: 13px; }
    .controls { margin-top: 8px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input[type="date"] {
      background: var(--card2); border: 1px solid var(--line); color: var(--text);
      padding: 8px 10px; border-radius: 8px;
    }
    button {
      background: var(--acc); color: #fff; border: none; padding: 8px 12px; border-radius: 8px;
      cursor: pointer; font-weight: 600;
    }
    button.ghost { background: transparent; border: 1px solid var(--line); color: var(--text); }
    button.danger { background: var(--danger); }
    main { padding: 12px; }
    .stats { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 12px; margin-bottom: 12px; }
    .stat {
      background: var(--card2); padding: 10px 12px; border-radius: 10px; text-align: center;
      border: 1px solid var(--line);
    }
    .stat h3 { margin: 0; font-size: 13px; color: var(--muted); }
    .stat p { margin: 4px 0 0; font-size: 16px; font-weight: 700; }
    .hint { font-size: 12px; color: var(--muted); margin: 8px 0; }
    .blocks { display: grid; gap: 12px; }
    .block {
      background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 10px;
    }
    .block-header {
      display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px;
      border-bottom: 1px solid var(--line); padding-bottom: 6px;
    }
    .block-title { font-weight: 700; font-size: 15px; }
    .subex { background: var(--card2); border: 1px dashed var(--line); border-radius: 10px; padding: 8px; margin-top: 8px; }
    .subex-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
    .subex-row input[name="exName"] {
      flex: 1; background: #0f1320; border: 1px solid var(--line); color: var(--text);
      padding: 8px 10px; border-radius: 8px; font-weight: 600;
    }
    .sets { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
    .set {
      background: #101522; border: 1px solid var(--line); border-radius: 8px; padding: 8px;
      position: relative;
    }
    .set .num { font-size: 11px; color: var(--muted); margin-bottom: 6px; text-align: center; }
    .set .row { display: flex; gap: 6px; }
    .set input {
      width: 100%; background: #0f1320; border: 1px solid var(--line); color: var(--text);
      padding: 6px 8px; border-radius: 6px; text-align: center;
    }
    .set .rm {
      position: absolute; top: 6px; right: 6px; background: var(--danger); border: none;
      color: #fff; width: 22px; height: 22px; border-radius: 50%; font-weight: 800; cursor: pointer;
    }
    .block-actions { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .page-actions { display: flex; gap: 8px; position: fixed; left: 0; right: 0; bottom: 0; background: var(--card);
      border-top: 1px solid var(--line); padding: 8px 12px; z-index: 10; }
    .page-actions button { flex: 1; }
    @media (max-width: 420px) {
      .stats { grid-template-columns: 1fr 1fr; }
    }
    datalist option { color: #000; }
  </style>
</head>
<body>
  <header>
    <h1>Трекер тренировок</h1>
    <div class="muted">Один день = одна тренировка. Сохранение в Telegram CloudStorage</div>
    <div class="controls">
      <label for="date">Дата:</label>
      <input type="date" id="date" />
      <button id="save">Сохранить</button>
      <button id="clear" class="ghost">Очистить день</button>
    </div>
  </header>

  <main>
    <div class="stats">
      <div class="stat"><h3>Тоннаж</h3><p id="statVolume">0 кг</p></div>
      <div class="stat"><h3>Повторы</h3><p id="statReps">0</p></div>
      <div class="stat"><h3>Макс. вес</h3><p id="statMax">0 кг</p></div>
    </div>

    <div class="hint">Добавляй суперсеты или одиночные упражнения. В каждом упражнении укажи вес и повторы — статистика обновится автоматически.</div>

    <div id="blocks" class="blocks"></div>
  </main>

  <div class="page-actions">
    <button id="addSingle" class="ghost">+ Упражнение</button>
    <button id="addSuperset" class="ghost">+ Суперсет</button>
  </div>

  <datalist id="exercise-suggestions">
    <option value="Жим лёжа штанга"></option>
    <option value="Жим гантелей лежа"></option>
    <option value="Подтягивания широким хватом"></option>
    <option value="Подтягивания узким хватом"></option>
    <option value="Тяга верхнего блока"></option>
    <option value="Тяга горизонтального блока"></option>
    <option value="Жим ногами"></option>
    <option value="Приседания со штангой"></option>
    <option value="Румынская тяга с гантелями"></option>
    <option value="Сгибания ног"></option>
    <option value="Разгибания ног"></option>
    <option value="Жим гантелей сидя"></option>
    <option value="Махи в стороны"></option>
    <option value="Подъем штанги на бицепс"></option>
    <option value="Французский жим"></option>
    <option value="Сведение рук в тренажере"></option>
    <option value="Разводка гантелей"></option>
    <option value="Гиперэкстензия"></option>
    <option value="Скручивания"></option>
    <option value="Планка"></option>
  </datalist>

  <template id="set-template">
    <div class="set">
      <div class="num">Подход 1</div>
      <div class="row">
        <input class="w" type="number" step="0.5" placeholder="кг" />
        <input class="r" type="number" placeholder="повт" />
      </div>
      <button class="rm" type="button">×</button>
    </div>
  </template>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();
    if (tg.setHeaderColor) tg.setHeaderColor('#171a21');
    if (tg.setBackgroundColor) tg.setBackgroundColor('#0f1115');

    const qs = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
    const $date = qs('#date');
    const $blocks = qs('#blocks');

    let blockCounter = 0;

    function todayISO() {
      const d = new Date();
      const tzOff = d.getTimezoneOffset() * 60000;
      return new Date(Date.now() - tzOff).toISOString().slice(0,10);
    }

    function haptic(type='light') {
      if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred(type);
    }

    function renumberSets($container) {
      qsa('.set', $container).forEach((el, idx) => el.querySelector('.num').textContent = `Подход ${idx+1}`);
    }

    function updateStats() {
      let totalVolume = 0, totalReps = 0, maxWeight = 0;
      qsa('.set').forEach(set => {
        const w = parseFloat(qs('.w', set).value) || 0;
        const r = parseInt(qs('.r', set).value) || 0;
        if (w > 0 && r > 0) {
          totalVolume += w * r;
          totalReps += r;
          if (w > maxWeight) maxWeight = w;
        }
      });
      qs('#statVolume').textContent = `${Math.round(totalVolume)} кг`;
      qs('#statReps').textContent = `${totalReps}`;
      qs('#statMax').textContent = `${maxWeight} кг`;
    }

    function createSet(values={}) {
      const tpl = qs('#set-template').content.cloneNode(true);
      const $set = tpl.querySelector('.set');
      const $w = qs('.w', $set);
      const $r = qs('.r', $set);
      if (values.weight != null) $w.value = values.weight;
      if (values.reps != null) $r.value = values.reps;
      $w.addEventListener('input', updateStats);
      $r.addEventListener('input', updateStats);
      qs('.rm', $set).addEventListener('click', () => {
        $set.remove();
        renumberSets($set.parentElement);
        updateStats();
        haptic('light');
      });
      return $set;
    }

    function subExerciseTemplate(title='Упражнение', suggested=true) {
      const $sub = document.createElement('div');
      $sub.className = 'subex';
      $sub.innerHTML = `
        <div class="subex-row">
          <input name="exName" placeholder="${title}" ${suggested ? 'list="exercise-suggestions"' : ''} />
          <button class="ghost addSet" type="button">+ подход</button>
        </div>
        <div class="sets"></div>
      `;
      const $sets = qs('.sets', $sub);
      // стартовые 3 подхода
      for (let i=0;i<3;i++) $sets.appendChild(createSet());
      renumberSets($sets);
      updateStats();
      qs('.addSet', $sub).addEventListener('click', () => {
        $sets.appendChild(createSet());
        renumberSets($sets);
        updateStats();
        haptic('light');
      });
      return $sub;
    }

    function addBlock(type='single') {
      blockCounter += 1;
      const supersetIndex = blockCounter;
      const $block = document.createElement('div');
      $block.className = 'block';
      $block.dataset.superset = String(supersetIndex);

      const title = type === 'superset' ? `Суперсет ${supersetIndex}` : `Упражнение ${supersetIndex}`;
      $block.innerHTML = `
        <div class="block-header">
          <div class="block-title">${title}</div>
          <div class="block-actions">
            <button class="ghost addSetAll" type="button">+ подход всем</button>
            <button class="danger removeBlock" type="button">Удалить</button>
          </div>
        </div>
      `;
      if (type === 'superset') {
        $block.appendChild(subExerciseTemplate('Упражнение 1'));
        $block.appendChild(subExerciseTemplate('Упражнение 2'));
      } else {
        $block.appendChild(subExerciseTemplate('Упражнение'));
      }
      qs('.removeBlock', $block).addEventListener('click', () => {
        $block.remove();
        renumberBlocks();
        updateStats();
        haptic('medium');
      });
      qs('.addSetAll', $block).addEventListener('click', () => {
        qsa('.subex', $block).forEach($sub => {
          const $sets = qs('.sets', $sub);
          $sets.appendChild(createSet());
          renumberSets($sets);
        });
        updateStats();
        haptic('light');
      });

      $blocks.appendChild($block);
      haptic('light');
    }

    function renumberBlocks() {
      let idx = 1;
      qsa('.block').forEach($b => {
        $b.dataset.superset = String(idx);
        const $title = qs('.block-title', $b);
        if ($title.textContent.startsWith('Суперсет')) {
          $title.textContent = `Суперсет ${idx}`;
        } else {
          $title.textContent = `Упражнение ${idx}`;
        }
        idx++;
      });
    }

    function collectWorkoutData() {
      // Сбор в формате OLD: список exercises со свойством superset
      const data = {
        date: $date.value,
        exercises: [],
        totalVolume: 0,
        totalReps: 0,
        userId: tg.initDataUnsafe?.user?.id || 'local'
      };

      qsa('.block').forEach(($block, bi) => {
        const sup = bi + 1; // superset index
        qsa('.subex', $block).forEach($sub => {
          const name = qs('input[name="exName"]', $sub).value.trim();
          if (!name) return;
          const sets = [];
          let exVol = 0, exReps = 0, maxW = 0;
          qsa('.set', $sub).forEach($set => {
            const w = parseFloat(qs('.w', $set).value) || 0;
            const r = parseInt(qs('.r', $set).value) || 0;
            if (w > 0 && r > 0) {
              sets.push({ weight: w, reps: r });
              exVol += w * r; exReps += r; if (w > maxW) maxW = w;
            }
          });
          if (sets.length > 0) {
            data.exercises.push({
              superset: sup,
              name,
              sets,
              volume: Math.round(exVol),
              totalReps: exReps,
              maxWeight: maxW
            });
            data.totalVolume += exVol;
            data.totalReps += exReps;
          }
        });
      });

      data.totalVolume = Math.round(data.totalVolume);
      return data;
    }

    function populateFromWorkout(workout) {
      // Очистить и построить блоки из exercises (группировка по superset)
      $blocks.innerHTML = '';
      blockCounter = 0;
      const bySup = {};
      (workout.exercises || []).forEach(ex => {
        bySup[ex.superset] = bySup[ex.superset] || [];
        bySup[ex.superset].push(ex);
      });
      const supKeys = Object.keys(bySup).map(n => parseInt(n,10)).sort((a,b)=>a-b);
      if (supKeys.length === 0) {
        // дефолт: один суперсет и одно одиночное
        addBlock('superset');
        addBlock('single');
        updateStats();
        return;
      }
      supKeys.forEach(k => {
        const group = bySup[k];
        const type = group.length >= 2 ? 'superset' : 'single';
        addBlock(type);
        const $block = qsa('.block')[$(qsa('.block')).length-1]; // but there's no $ helper; adjust
      });
      // The above attempt to get last block using jQuery-like syntax is wrong; implement properly:
      // So re-render correctly:
      $blocks.innerHTML = '';
      blockCounter = 0;
      supKeys.forEach(k => {
        const group = bySup[k];
        const type = group.length >= 2 ? 'superset' : 'single';
        addBlock(type);
        const allBlocks = qsa('.block');
        const $block = allBlocks[allBlocks.length - 1];
        // fill subex
        const $subs = qsa('.subex', $block);
        group.forEach((ex, i) => {
          const $sub = $subs[i] || $subs[0]; // safeguard
          qs('input[name="exName"]', $sub).value = ex.name || '';
          const $sets = qs('.sets', $sub);
          $sets.innerHTML = '';
          (ex.sets || []).forEach(s => {
            const $set = createSet({ weight: s.weight, reps: s.reps });
            $sets.appendChild($set);
          });
          renumberSets($sets);
        });
      });
      updateStats();
    }

    function saveToCloud(workoutData, cb) {
      const key = 'workouts';
      tg.CloudStorage.getItem(key, (error, value) => {
        let workouts = [];
        if (value) {
          try { workouts = JSON.parse(value) || []; } catch (e) { workouts = []; }
        } else {
          const local = localStorage.getItem(key);
          if (local) { try { workouts = JSON.parse(local) || []; } catch (e) { workouts = []; } }
        }
        // заменить запись по дате, иначе добавить
        const idx = workouts.findIndex(w => w.date === workoutData.date);
        if (idx >= 0) workouts[idx] = workoutData;
        else workouts.push(workoutData);
        // ограничение размера
        if (workouts.length > 200) workouts = workouts.slice(-200);

        tg.CloudStorage.setItem(key, JSON.stringify(workouts), (err) => {
          if (err) {
            // fallback
            try { localStorage.setItem(key, JSON.stringify(workouts)); } catch (e) {}
          }
          if (typeof cb === 'function') cb();
        });
      });
    }

    function loadFromCloud(cb) {
      const key = 'workouts';
      tg.CloudStorage.getItem(key, (error, value) => {
        if (error) {
          const local = localStorage.getItem(key);
          if (local) {
            try { cb(JSON.parse(local)); return; } catch (e) { cb([]); return; }
          }
          cb([]); return;
        }
        if (value) {
          try { cb(JSON.parse(value)); } catch (e) { cb([]); }
        } else cb([]);
      });
    }

    function loadForDate(dateStr) {
      loadFromCloud((list) => {
        const w = (list || []).find(x => x.date === dateStr);
        if (w) populateFromWorkout(w);
        else {
          // по умолчанию — стартовая заготовка
          $blocks.innerHTML = '';
          blockCounter = 0;
          addBlock('superset');
          addBlock('single');
          updateStats();
        }
      });
    }

    function clearDay(dateStr, cb) {
      const key = 'workouts';
      tg.CloudStorage.getItem(key, (error, value) => {
        let workouts = [];
        if (value) {
          try { workouts = JSON.parse(value) || []; } catch (e) { workouts = []; }
        }
        const filtered = workouts.filter(w => w.date !== dateStr);
        tg.CloudStorage.setItem(key, JSON.stringify(filtered), (err) => {
          if (err) {
            try { localStorage.setItem(key, JSON.stringify(filtered)); } catch (e) {}
          }
          if (typeof cb === 'function') cb();
        });
      });
    }

    // Events
    qs('#addSingle').addEventListener('click', () => addBlock('single'));
    qs('#addSuperset').addEventListener('click', () => addBlock('superset'));

    qs('#save').addEventListener('click', () => {
      if (!$date.value) return tg.showAlert('Выбери дату');
      const workoutData = collectWorkoutData();
      if (!workoutData.exercises.length) {
        tg.showAlert('Добавь хотя бы одно упражнение с подходами');
        return;
      }
      saveToCloud(workoutData, () => {
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        tg.showPopup({
          title: 'Сохранено',
          message: `📅 ${new Date(workoutData.date).toLocaleDateString('ru-RU')}\n⚖️ ${workoutData.totalVolume} кг • 🔄 ${workoutData.totalReps} повт.`,
          buttons: [{ type: 'ok' }]
        });
      });
    });

    qs('#clear').addEventListener('click', () => {
      if (!$date.value) return tg.showAlert('Выбери дату');
      tg.showConfirm(`Очистить тренировку за ${new Date($date.value).toLocaleDateString('ru-RU')}?`, (ok) => {
        if (!ok) return;
        clearDay($date.value, () => {
          $blocks.innerHTML = '';
          blockCounter = 0;
          addBlock('superset');
          addBlock('single');
          updateStats();
          tg.showAlert('День очищен');
        });
      });
    });

    $date.addEventListener('change', (e) => loadForDate(e.target.value));

    // Init
    $date.value = todayISO();
    loadForDate($date.value);
  </script>
</body>
</html>
