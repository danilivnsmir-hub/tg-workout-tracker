<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Трекер тренировок</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0f1115; --card: #171a21; --muted: #9aa4b2; --text: #e6e9ef;
      --acc: #4f8cff; --line: #2a2f3a; --card2: #131720;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    header { background: var(--card); padding: 12px; position: sticky; top: 0; z-index: 5; border-bottom: 1px solid var(--line); }
    h1 { margin: 0; font-size: 18px; }
    .muted { color: var(--muted); font-size: 13px; }
    .controls { margin-top: 8px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input[type="date"] { background: var(--card2); border: 1px solid var(--line); color: var(--text); padding: 8px 10px; border-radius: 8px; }
    button { background: var(--acc); color: #fff; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    button.ghost { background: transparent; border: 1px solid var(--line); color: var(--text); }
    button.warn { background: #f59e0b; }
    main { padding: 12px; }
    .day { background: var(--card); border-radius: 12px; padding: 10px; margin-bottom: 12px; border: 1px solid var(--line); }
    .day h2 { margin: 0 0 6px; font-size: 16px; }
    .desc { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .exercise { background: var(--card2); border: 1px dashed var(--line); border-radius: 8px; padding: 8px; margin-top: 8px; }
    .ex-header { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
    .ex-header input[name="exName"] { flex: 1; background: #0f1320; border: 1px solid var(--line); color: var(--text); padding: 8px 10px; border-radius: 8px; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--line); padding: 6px; font-size: 13px; text-align: left; }
    .table input { width: 100%; background: #0f1320; border: 1px solid var(--line); color: var(--text); padding: 6px 8px; border-radius: 6px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    @media (max-width: 720px) {
      .table th:nth-child(2), .table td:nth-child(2) { display: none; } /* скрыть # на мобилках */
    }
  </style>
</head>
<body>
  <header>
    <h1>Трекер тренировок</h1>
    <div class="muted">Сохранение в Telegram CloudStorage</div>
    <div class="controls">
      <label for="date">Дата:</label>
      <input type="date" id="date" />
      <button id="save">Сохранить</button>
      <button id="clear" class="ghost">Очистить день</button>
    </div>
  </header>

  <main>
    <section class="day" id="day1">
      <h2>День 1 — Грудь + Спина</h2>
      <p class="desc">Суперсеты, 8–15 повт, отдых 45–75 с, RPE 7–8</p>
      <div class="exercises"></div>
      <div class="actions">
        <button class="ghost add-ex" data-day="day1">+ упражнение</button>
      </div>
    </section>

    <section class="day" id="day2">
      <h2>День 2 — Ноги + Кор</h2>
      <p class="desc">Умеренный вес, 10–15 повт, эксцентрика 3 с, RPE 6–7</p>
      <div class="exercises"></div>
      <div class="actions">
        <button class="ghost add-ex" data-day="day2">+ упражнение</button>
      </div>
    </section>

    <section class="day" id="day3">
      <h2>День 3 — Плечи + Тяга + Руки</h2>
      <p class="desc">8–20 повт, пауза в пике, финишеры на памп, RPE 7–8</p>
      <div class="exercises"></div>
      <div class="actions">
        <button class="ghost add-ex" data-day="day3">+ упражнение</button>
      </div>
    </section>
  </main>

  <template id="exercise-template">
    <div class="exercise">
      <div class="ex-header">
        <input name="exName" placeholder="Название упражнения" />
        <button class="ghost add-set" type="button">+ подход</button>
        <button class="ghost remove-ex" type="button">Удалить упражнение</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Подход</th>
            <th>Вес</th>
            <th>Повторы</th>
            <th>RPE</th>
            <th>Заметки</th>
            <th></th>
          </tr>
        </thead>
        <tbody class="sets"></tbody>
      </table>
    </div>
  </template>

  <template id="set-template">
    <tr>
      <td class="idx">1</td>
      <td><input type="number" inputmode="numeric" placeholder="1" /></td>
      <td><input type="number" step="0.5" inputmode="decimal" placeholder="кг" /></td>
      <td><input type="number" inputmode="numeric" placeholder="повт" /></td>
      <td><input type="number" step="0.5" inputmode="decimal" placeholder="RPE" /></td>
      <td><input type="text" placeholder="заметки (суперсет, дроп-сет, пауза…)" /></td>
      <td><button class="ghost remove-set" type="button">×</button></td>
    </tr>
  </template>

  <script>
    // Telegram WebApp init
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    if (tg.setHeaderColor) tg.setHeaderColor('#171a21');
    const user = tg.initDataUnsafe?.user;

    const qs = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));

    const defaultPlan = {
      day1: ["Жим лёжа", "Подтягивания / Тяга гориз. блока", "Жим гантелей на наклонной", "Тяга гантели в наклоне", "Face pull", "Планка (сек)"],
      day2: ["Болгарские сплит‑приседы", "Жим ногами (если без боли)", "Румынская тяга с гантелями", "Шаги на тумбу / Санки", "Сгибания ног", "Планка (сек)", "Dead bug / Bird‑dog"],
      day3: ["Жим гантелей сидя", "Тяга сверху / Подтягивания", "Махи в стороны", "Тяга к лицу", "Сгибания на бицепс", "Французский жим", "Велосипед (сек)"]
    };

    function todayISO() {
      const d = new Date();
      const tzOff = d.getTimezoneOffset() * 60000;
      return new Date(Date.now() - tzOff).toISOString().slice(0,10);
    }

    function renumber(tbody) {
      qsa('tr', tbody).forEach((tr,i)=> tr.querySelector('.idx').textContent = i+1);
    }

    function createExercise(name="") {
      const tpl = qs('#exercise-template').content.cloneNode(true);
      const ex = tpl.querySelector('.exercise');
      const nameInput = ex.querySelector('input[name="exName"]');
      nameInput.value = name;
      const setsBody = ex.querySelector('.sets');

      function addSetRow(values={}) {
        const stpl = qs('#set-template').content.cloneNode(true);
        const row = stpl.querySelector('tr');
        const ins = row.querySelectorAll('input');
        // order: set, weight, reps, rpe, note
        ins[0].value = values.set ?? '';
        ins[1].value = values.weight ?? '';
        ins[2].value = values.reps ?? '';
        ins[3].value = values.rpe ?? '';
        ins[4].value = values.note ?? '';
        row.querySelector('.remove-set').addEventListener('click', ()=>{ row.remove(); renumber(setsBody); });
        setsBody.appendChild(row);
        renumber(setsBody);
      }

      ex.querySelector('.add-set').addEventListener('click', ()=> addSetRow());
      ex.querySelector('.remove-ex').addEventListener('click', ()=> ex.remove());
      // стартовый пустой подход
      addSetRow();
      return ex;
    }

    function renderDay(dayId, planNames) {
      const container = qs(`#${dayId} .exercises`);
      container.innerHTML = '';
      planNames.forEach(n => container.appendChild(createExercise(n)));
    }

    function collectDay(dayId) {
      const day = qs(`#${dayId}`);
      const data = [];
      qsa('.exercise', day).forEach(ex => {
        const name = qs('input[name="exName"]', ex).value.trim();
        const sets = [];
        qsa('tbody.sets tr', ex).forEach(tr => {
          const ins = tr.querySelectorAll('input');
          sets.push({
            set: ins[0].value || '',
            weight: ins[1].value || '',
            reps: ins[2].value || '',
            rpe: ins[3].value || '',
            note: ins[4].value || ''
          });
        });
        data.push({ name, sets });
      });
      return data;
    }

    function populateDay(dayId, data) {
      const container = qs(`#${dayId} .exercises`);
      container.innerHTML = '';
      (data || []).forEach(exData => {
        const ex = createExercise(exData.name || '');
        const setsBody = ex.querySelector('.sets');
        setsBody.innerHTML = '';
        (exData.sets || []).forEach(s => {
          const stpl = qs('#set-template').content.cloneNode(true);
          const row = stpl.querySelector('tr');
          const inputs = row.querySelectorAll('input');
          inputs[0].value = s.set ?? '';
          inputs[1].value = s.weight ?? '';
          inputs[2].value = s.reps ?? '';
          inputs[3].value = s.rpe ?? '';
          inputs[4].value = s.note ?? '';
          row.querySelector('.remove-set').addEventListener('click', () => { row.remove(); renumber(setsBody); });
          setsBody.appendChild(row);
        });
        renumber(setsBody);
        container.appendChild(ex);
      });
    }

    function loadWorkout(date) {
      tg.CloudStorage.getItem(`workout_${date}`, (err, value) => {
        if (err) {
          tg.showAlert('Ошибка загрузки данных');
          return;
        }
        if (value) {
          try {
            const data = JSON.parse(value);
            populateDay('day1', data.day1);
            populateDay('day2', data.day2);
            populateDay('day3', data.day3);
          } catch (e) {
            console.error(e);
            renderDefaults();
          }
        } else {
          renderDefaults();
        }
      });
    }

    function renderDefaults() {
      renderDay('day1', defaultPlan.day1);
      renderDay('day2', defaultPlan.day2);
      renderDay('day3', defaultPlan.day3);
    }

    function saveWorkoutsIndex(date) {
      // обновляем общий список дат для главной страницы (index.html читает 'workouts')
      tg.CloudStorage.getItem('workouts', (err, value) => {
        let workouts = [];
        if (value) {
          try { workouts = JSON.parse(value) || []; } catch {}
        }
        const exists = workouts.some(w => w.date === date);
        if (!exists) workouts.push({ date, savedAt: new Date().toISOString() });
        // храним не больше 180 записей, чтобы не раздувать
        workouts = workouts.slice(-180);
        tg.CloudStorage.setItem('workouts', JSON.stringify(workouts), () => {});
      });
    }

    // Events
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.add-ex');
      if (btn) {
        qs(`#${btn.dataset.day} .exercises`).appendChild(createExercise('Новое упражнение'));
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      }
    });

    qs('#save').addEventListener('click', () => {
      const date = qs('#date').value;
      if (!date) return tg.showAlert('Выбери дату');
      const payload = {
        userId: user?.id,
        username: user?.username,
        date,
        day1: collectDay('day1'),
        day2: collectDay('day2'),
        day3: collectDay('day3'),
        savedAt: new Date().toISOString()
      };
      tg.CloudStorage.setItem(`workout_${date}`, JSON.stringify(payload), (err, ok) => {
        if (ok) {
          saveWorkoutsIndex(date);
          if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
          tg.showAlert('Тренировка сохранена ✅');
        } else {
          if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
          tg.showAlert('Ошибка сохранения');
        }
      });
    });

    qs('#clear').addEventListener('click', () => {
      const date = qs('#date').value;
      if (!date) return tg.showAlert('Выбери дату');
      tg.CloudStorage.removeItem(`workout_${date}`, (err, ok) => {
        renderDefaults();
        tg.showAlert('День очищен');
      });
    });

    qs('#date').addEventListener('change', (e) => {
      loadWorkout(e.target.value);
    });

    // Init
    qs('#date').value = todayISO();
    loadWorkout(qs('#date').value);
  </script>
</body>
</html>
