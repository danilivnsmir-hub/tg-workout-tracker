<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Workout Tracker - Telegram App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
    * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    }

    body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: var(--tg-theme-bg-color, #fff);
    color: var(--tg-theme-text-color, #000);
    padding-bottom: 60px;
    overflow-x: hidden;
    }

    .header {
    background: var(--tg-theme-header-bg-color, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
    color: white;
    padding: 15px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    }

    .header h1 {
    font-size: 20px;
    font-weight: 600;
    }

    .header-back {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: #fff;
    font-size: 20px;
    cursor: pointer;
    }

    .date-selector {
    background: var(--tg-theme-secondary-bg-color, #f0f0f0);
    padding: 10px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
    }

    .date-selector input {
    background: var(--tg-theme-bg-color, white);
    border: 1px solid var(--tg-theme-hint-color, #ccc);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 16px;
    color: var(--tg-theme-text-color, #000);
    }

    .quick-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    padding: 15px;
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    }

    .stat-mini {
    background: var(--tg-theme-bg-color, white);
    padding: 12px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stat-mini-value {
    font-size: 24px;
    font-weight: bold;
    color: var(--tg-theme-link-color, #667eea);
    }

    .stat-mini-label {
    font-size: 12px;
    color: var(--tg-theme-hint-color, #999);
    margin-top: 4px;
    }

    .container {
    padding: 15px;
    }

    .superset {
    background: var(--tg-theme-bg-color, white);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    }

    .superset-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    }

    .superset-title {
    font-weight: 600;
    color: var(--tg-theme-link-color, #667eea);
    font-size: 16px;
    }

    .exercise-block {
    margin-bottom: 15px;
    }

    .exercise-select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 6px;
    background: var(--tg-theme-bg-color, white);
    color: var(--tg-theme-text-color, #000);
    }

    .record-hint {
    font-size: 12px;
    color: var(--tg-theme-hint-color, #888);
    margin-bottom: 8px;
    }

    .sets-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 8px;
    }

    .set-block {
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border-radius: 8px;
    padding: 8px 28px 8px 8px; /* –º–µ—Å—Ç–æ –ø–æ–¥ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è */
    border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    position: relative;
    }

    .set-remove-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: none;
    background: #ff4d4f;
    color: #fff;
    font-weight: 700;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    opacity: 0.9;
    }
    .set-remove-btn:active { transform: scale(0.96); opacity: 1; }

    .set-number {
    font-size: 11px;
    color: var(--tg-theme-hint-color, #999);
    margin-bottom: 4px;
    text-align: center;
    }

    .set-inputs {
    display: flex;
    gap: 4px;
    }

    .set-inputs input {
    width: 50%;
    padding: 6px 4px;
    border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    border-radius: 6px;
    font-size: 14px;
    text-align: center;
    background: var(--tg-theme-bg-color, white);
    color: var(--tg-theme-text-color, #000);
    }

    .set-inputs input:focus {
    outline: none;
    border-color: var(--tg-theme-link-color, #667eea);
    }

    .btn {
    width: 100%;
    padding: 12px;
    background: var(--tg-theme-button-color, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
    color: var(--tg-theme-button-text-color, white);
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
    }

    .btn:active {
    transform: scale(0.98);
    }

    .btn-small {
    padding: 6px 12px;
    font-size: 14px;
    }

    .btn-danger {
    background: #dc3545;
    }

    .btn-add {
    background: var(--tg-theme-secondary-bg-color, #f0f0f0);
    color: var(--tg-theme-link-color, #667eea);
    border: 2px dashed var(--tg-theme-link-color, #667eea);
    margin-bottom: 15px;
    }

    .bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--tg-theme-bg-color, white);
    border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    padding: 8px 10px;
    display: flex;
    gap: 8px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    }

    .bottom-bar::-webkit-scrollbar { height: 6px; }
    .bottom-bar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }

    .tab-btn {
    flex: 1 0 20%;
    min-width: 72px;
    padding: 6px;
    background: transparent;
    border: none;
    color: var(--tg-theme-hint-color, #999);
    font-size: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    cursor: pointer;
    }

    .tab-btn.active {
    color: var(--tg-theme-link-color, #667eea);
    }

    .tab-btn-icon {
    font-size: 18px;
    }

    .tab-content {
    display: none;
    }

    .tab-content.active {
    display: block;
    }

    .history-item {
    background: var(--tg-theme-bg-color, white);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    }

    .history-date {
    font-weight: 600;
    color: var(--tg-theme-text-color, #000);
    margin-bottom: 8px;
    }

    .history-stats {
    display: flex;
    justify-content: space-between;
    color: var(--tg-theme-hint-color, #666);
    font-size: 14px;
    }

    .exercise-item {
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    }

    .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--tg-theme-hint-color, #999);
    }

    .empty-state-icon {
    font-size: 48px;
    margin-bottom: 10px;
    }

    .loading {
    text-align: center;
    padding: 20px;
    color: var(--tg-theme-hint-color, #999);
    }

    .section-title {
    margin: 20px 0 10px;
    color: var(--tg-theme-text-color, #000);
    }

    canvas {
    width: 100%;
    height: 200px;
    background: var(--tg-theme-bg-color, #fff);
    border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    border-radius: 8px;
    }

    @media (max-width: 360px) {
    .sets-container {
    grid-template-columns: repeat(2, 1fr);
    }
    }
    </style>
</head>
<body>
    <div class="header" style="position: sticky; top: 0;">
    <button class="header-back" onclick="goBack()" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
    <h1>üí™ Workout Tracker</h1>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
    <div id="workout-tab" class="tab-content active">
    <div class="date-selector">
    <label for="workout-date">–î–∞—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:</label>
    <input type="date" id="workout-date">
    </div>

    <div class="quick-stats">
    <div class="stat-mini">
    <div class="stat-mini-value" id="current-volume">0</div>
    <div class="stat-mini-label">–¢–æ–Ω–Ω–∞–∂ (–∫–≥)</div>
    </div>
    <div class="stat-mini">
    <div class="stat-mini-value" id="current-reps">0</div>
    <div class="stat-mini-label">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</div>
    </div>
    </div>

    <div class="container" id="supersets-container">
    <!-- –ë–ª–æ–∫–∏ (—Å—É–ø–µ—Ä—Å–µ—Ç/—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ) –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>

    <div class="container">
    <button id="add-btn" class="btn btn-add" onclick="addItem()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—É–ø–µ—Ä—Å–µ—Ç</button>
    <button class="btn" onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
    </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
    <div id="history-tab" class="tab-content">
    <div class="container" id="history-container">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div id="stats-tab" class="tab-content">
    <div class="container">
    <div class="quick-stats">
    <div class="stat-mini">
    <div class="stat-mini-value" id="total-workouts">0</div>
    <div class="stat-mini-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
    </div>
    <div class="stat-mini">
    <div class="stat-mini-value" id="total-volume">0</div>
    <div class="stat-mini-label">–û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂</div>
    </div>
    <div class="stat-mini">
    <div class="stat-mini-value" id="avg-volume">0</div>
    <div class="stat-mini-label">–°—Ä–µ–¥–Ω–∏–π —Ç–æ–Ω–Ω–∞–∂</div>
    </div>
    <div class="stat-mini">
    <div class="stat-mini-value" id="total-exercises">0</div>
    <div class="stat-mini-label">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>
    </div>
    </div>

    <h3 class="section-title">–¢–æ–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:</h3>
    <div id="top-exercises"></div>

    <h3 class="section-title">–†–µ–∫–æ—Ä–¥—ã (–º–∞–∫—Å. –≤–µ—Å):</h3>
    <div id="records-list"></div>

    <h3 class="section-title">–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:</h3>
    <div style="display:flex; gap:10px; margin-bottom:10px;">
    <select id="progress-exercise-select" class="exercise-select" style="flex:1;" onchange="updateProgressChart()">
    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>
    </select>
    </div>
    <canvas id="progress-canvas" width="600" height="220"></canvas>
    <div id="progress-empty" class="empty-state" style="display:none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>
    <div id="progress-1rm" class="record-hint" style="text-align:center; margin-top:8px;"></div>
    </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
    <div id="exercises-tab" class="tab-content">
    <div class="container">
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
    <input type="text" id="new-exercise" placeholder="–ù–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" style="flex: 1; padding: 10px; border: 1px solid var(--tg-theme-hint-color, #ccc); border-radius: 8px;">
    <button class="btn btn-small" onclick="addExercise()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="exercises-list"></div>
    </div>
    <div class="exercise-summary">
    <span class="exercise-tonnage">–¢–æ–Ω–Ω–∞–∂: 0 –∫–≥</span> |
    <span class="exercise-reps">–ü–æ–≤—Ç–æ—Ä–æ–≤: 0</span>
    </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settings-tab" class="tab-content">
    <div class="container">
    <h3 class="section-title">–†–µ–∂–∏–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
    <select id="mode-select" class="exercise-select" onchange="changeMode(this.value)">
    <option value="superset">–°—É–ø–µ—Ä—Å–µ—Ç–∞–º–∏</option>
    <option value="single">–û–¥–∏–Ω–æ—á–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</option>
    </select>
    <div style="font-size:13px; color:var(--tg-theme-hint-color, #777); margin-top:6px;">
    –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∫–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑—É –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ ‚Äú–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ‚Äù, –∏ –∫–∞–∂–¥—ã–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ.
    </div>
    </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <div class="bottom-bar">
    <button class="tab-btn active" onclick="showTab(this, 'workout')">
    <span class="tab-btn-icon">üèãÔ∏è</span>
    <span>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span>
    </button>
    <button class="tab-btn" onclick="showTab(this, 'history')">
    <span class="tab-btn-icon">üìã</span>
    <span>–ò—Å—Ç–æ—Ä–∏—è</span>
    </button>
    <button class="tab-btn" onclick="showTab(this, 'stats')">
    <span class="tab-btn-icon">üìä</span>
    <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
    </button>
    <button class="tab-btn" onclick="showTab(this, 'exercises')">
    <span class="tab-btn-icon">üí™</span>
    <span>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</span>
    </button>
    <button class="tab-btn" onclick="showTab(this, 'settings')">
    <span class="tab-btn-icon">‚öôÔ∏è</span>
    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
    </button>
    </div>

    <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã
    tg.setHeaderColor('secondary_bg_color');
    tg.setBackgroundColor('bg_color');

    // –ë–∞–∑–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
    let exercises = [
    '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è —à–∏—Ä–æ–∫–∏–º —Ö–≤–∞—Ç–æ–º',
    '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è —É–∑–∫–∏–º —Ö–≤–∞—Ç–æ–º',
    '–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö',
    '–ñ–∏–º –ª–µ–∂–∞ —à—Ç–∞–Ω–≥–∞',
    '–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª–µ–∂–∞',
    '–†–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥',
    '–°–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥',
    '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å–æ —à—Ç–∞–Ω–≥–æ–π',
    '–ñ–∏–º –Ω–æ–≥–∞–º–∏',
    '–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞',
    '–¢—è–≥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞',
    '–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è',
    '–ú–∞—Ö–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—ã',
    '–ü–æ–¥—ä–µ–º —à—Ç–∞–Ω–≥–∏ –Ω–∞ –±–∏—Ü–µ–ø—Å',
    '–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º',
    '–°–≤–µ–¥–µ–Ω–∏–µ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ',
    '–†–∞–∑–≤–æ–¥–∫–∞ –≥–∞–Ω—Ç–µ–ª–µ–π',
    '–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è',
    '–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è',
    '–ü–ª–∞–Ω–∫–∞'
    ];

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ä–µ–∫–æ—Ä–¥—ã
    let settings = { mode: 'superset' }; // 'superset' | 'single'
    let records = {}; // { [exerciseName]: maxWeight }
    let currentSupersetCount = 0;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('workout-date').value = new Date().toISOString().split('T')[0];

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (exercises, settings, records)
    loadAll(() => {
    // –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏
    buildInitialItems();
    // –û–±–Ω–æ–≤–∏—Ç—å —ç–∫—Ä–∞–Ω—ã
    updateExercisesList();
    updateStats();
    populateProgressExerciseSelect();
    updateModeUI();
    refreshRecordHints();

    // –î–ª—è —á–µ—Ç–∫–æ–≥–æ canvas –Ω–∞ —Ä–µ—Ç–∏–Ω–∞
    resizeCanvasToDevicePixelRatio(document.getElementById('progress-canvas'));
    });
    });

    function showTab(btn, tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');

    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');

    if (tabName === 'history') {
    updateHistory();
    } else if (tabName === 'stats') {
    updateStats();
    updateProgressChart(); // –æ–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    }

    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –∏—Å—Ö–æ–¥—è –∏–∑ —Ä–µ–∂–∏–º–∞
    function buildInitialItems() {
    document.getElementById('supersets-container').innerHTML = '';
    currentSupersetCount = 0;

    // –î–æ–±–∞–≤–∏–º 3 –±–ª–æ–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    if (settings.mode === 'superset') {
    addSuperset();
    addSuperset();
    addSuperset();
    } else {
    addSingleExercise();
    addSingleExercise();
    addSingleExercise();
    }
    updateCurrentStats();
    }

    function updateModeUI() {
    const addBtn = document.getElementById('add-btn');
    if (settings.mode === 'single') {
    addBtn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
    } else {
    addBtn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—É–ø–µ—Ä—Å–µ—Ç';
    }
    // –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
    const modeSelect = document.getElementById('mode-select');
    if (modeSelect) modeSelect.value = settings.mode;
    }

    function addItem() {
    if (settings.mode === 'single') {
    addSingleExercise();
    } else {
    addSuperset();
    }
    }

    function optionsHtml(arr) {
      return arr.map(ex => `<option value="${escapeHtml(ex)}">${escapeHtml(ex)}</option>`).join('');
    }

    function addSuperset() {
    currentSupersetCount++;
    const container = document.getElementById('supersets-container');

    const supersetDiv = document.createElement('div');
    supersetDiv.className = 'superset';
    supersetDiv.id = `superset-${currentSupersetCount}`;

    supersetDiv.innerHTML = `
    <div class="superset-header">
    <span class="superset-title">–°—É–ø–µ—Ä—Å–µ—Ç ${currentSupersetCount}</span>
    <button class="btn btn-small btn-danger" onclick="removeSuperset(${currentSupersetCount})">‚úï</button>
    </div>

    <div class="exercise-block">
    <select class="exercise-select" onchange="updateCurrentStats(); refreshRecordHints();">
    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 1</option>
    ${optionsHtml(exercises)}
    </select>
    <div class="record-hint"></div>
    <div class="sets-container" id="sets-${currentSupersetCount}-1">
    ${createSetBlocks(4)}
    </div>
    <button class="btn btn-small" style="margin-top: 8px;" onclick="addSet(${currentSupersetCount}, 1)">+ –ü–æ–¥—Ö–æ–¥</button>
    </div>

    <div class="exercise-block">
    <select class="exercise-select" onchange="updateCurrentStats(); refreshRecordHints();">
    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 2</option>
    ${optionsHtml(exercises)}
    </select>
    <div class="record-hint"></div>
    <div class="sets-container" id="sets-${currentSupersetCount}-2">
    ${createSetBlocks(4)}
    </div>
    <button class="btn btn-small" style="margin-top: 8px;" onclick="addSet(${currentSupersetCount}, 2)">+ –ü–æ–¥—Ö–æ–¥</button>
    </div>
    `;

    container.appendChild(supersetDiv);
    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    refreshRecordHints();
    }

    function addSingleExercise() {
    currentSupersetCount++;
    const container = document.getElementById('supersets-container');

    const blockDiv = document.createElement('div');
    blockDiv.className = 'superset';
    blockDiv.id = `superset-${currentSupersetCount}`;

    blockDiv.innerHTML = `
    <div class="superset-header">
    <span class="superset-title">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ${currentSupersetCount}</span>
    <button class="btn btn-small btn-danger" onclick="removeSuperset(${currentSupersetCount})">‚úï</button>
    </div>

    <div class="exercise-block">
    <select class="exercise-select" onchange="updateCurrentStats(); refreshRecordHints();">
    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>
    ${optionsHtml(exercises)}
    </select>
    <div class="record-hint"></div>
    <div class="sets-container" id="sets-${currentSupersetCount}-1">
    ${createSetBlocks(4)}
    </div>
    <button class="btn btn-small" style="margin-top: 8px;" onclick="addSet(${currentSupersetCount}, 1)">+ –ü–æ–¥—Ö–æ–¥</button>
    </div>
    `;

    container.appendChild(blockDiv);
    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    refreshRecordHints();
    }

    function createSetBlocks(count) {
    let html = '';
    for (let i = 1; i <= count; i++) {
    html += `
    <div class="set-block">
    <div class="set-number">–ü–æ–¥—Ö–æ–¥ ${i}</div>
    <div class="set-inputs">
    <input type="number" placeholder="–∫–≥" class="weight-input" onchange="updateCurrentStats()">
    <input type="number" placeholder="√ó" class="reps-input" onchange="updateCurrentStats()">
    </div>
    <button class="set-remove-btn" onclick="removeSet(this)" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥">√ó</button>
    </div>
    `;
    }
    return html;
    }

    function addSet(supersetId, exerciseNum) {
    const container = document.getElementById(`sets-${supersetId}-${exerciseNum}`);
    const setCount = container.querySelectorAll('.set-block').length + 1;

    const setBlock = document.createElement('div');
    setBlock.className = 'set-block';
    setBlock.innerHTML = `
    <div class="set-number">–ü–æ–¥—Ö–æ–¥ ${setCount}</div>
    <div class="set-inputs">
    <input type="number" placeholder="–∫–≥" class="weight-input" onchange="updateCurrentStats()">
    <input type="number" placeholder="√ó" class="reps-input" onchange="updateCurrentStats()">
    </div>
    <button class="set-remove-btn" onclick="removeSet(this)" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥">√ó</button>
    `;

    container.appendChild(setBlock);
    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function removeSet(btn) {
    const setBlock = btn.closest('.set-block');
    if (!setBlock) return;
    const setsContainer = setBlock.parentElement; // .sets-container
    setBlock.remove();

    // –ü–µ—Ä–µ–Ω—É–º–µ—Ä–∞—Ü–∏—è
    setsContainer.querySelectorAll('.set-block .set-number').forEach((el, idx) => {
    el.textContent = `–ü–æ–¥—Ö–æ–¥ ${idx + 1}`;
    });

    // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É
    updateCurrentStats();

    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function removeSuperset(id) {
    const superset = document.getElementById(`superset-${id}`);
    if (superset) {
    superset.remove();
    updateCurrentStats();
    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
    }
    }

    function updateCurrentStats() {
    let totalVolume = 0;
    let totalReps = 0;

    document.querySelectorAll('.superset').forEach(superset => {
    superset.querySelectorAll('.exercise-block').forEach(block => {
    const exerciseName = block.querySelector('.exercise-select').value;
    if (!exerciseName) return;

    block.querySelectorAll('.set-block').forEach(setBlock => {
    const weight = parseFloat(setBlock.querySelector('.weight-input').value) || 0;
    const reps = parseInt(setBlock.querySelector('.reps-input').value) || 0;

    if (weight > 0 && reps > 0) {
    totalVolume += weight * reps;
    totalReps += reps;
    }
    });
    });
    });

    document.getElementById('current-volume').textContent = Math.round(totalVolume);
    document.getElementById('current-reps').textContent = totalReps;
    }

    function saveWorkout() {
    const date = document.getElementById('workout-date').value;
    const supersets = document.querySelectorAll('.superset');

    const workoutData = {
    date: date,
    exercises: [],
    totalVolume: 0,
    totalReps: 0,
    userId: tg.initDataUnsafe?.user?.id || 'local'
    };

    supersets.forEach((superset, supersetIndex) => {
    const exerciseBlocks = superset.querySelectorAll('.exercise-block');

    exerciseBlocks.forEach(block => {
    const exerciseName = block.querySelector('.exercise-select').value;
    if (!exerciseName) return;

    const sets = [];
    let exerciseVolume = 0;
    let exerciseReps = 0;
    let maxWeight = 0;

    block.querySelectorAll('.set-block').forEach(setBlock => {
    const weight = parseFloat(setBlock.querySelector('.weight-input').value) || 0;
    const reps = parseInt(setBlock.querySelector('.reps-input').value) || 0;

    if (weight > 0 && reps > 0) {
    sets.push({ weight, reps });
    exerciseVolume += weight * reps;
    exerciseReps += reps;
    maxWeight = Math.max(maxWeight, weight);
    }
    });

    if (sets.length > 0) {
    workoutData.exercises.push({
    superset: supersetIndex + 1,
    name: exerciseName,
    sets: sets,
    volume: exerciseVolume,
    totalReps: exerciseReps,
    maxWeight: maxWeight
    });

    workoutData.totalVolume += exerciseVolume;
    workoutData.totalReps += exerciseReps;
    }
    });
    });

    if (workoutData.exercises.length === 0) {
    tg.showAlert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å –≤–µ—Å–æ–º –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º–∏!');
    return;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–æ–≤
    saveToCloud(workoutData, () => {
    // –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã –ª–æ–∫–∞–ª—å–Ω–æ –∏ UI –ø–æ–¥—Å–∫–∞–∑–∫–∏
    workoutData.exercises.forEach(ex => {
    if (!records[ex.name] || ex.maxWeight > records[ex.name]) {
    records[ex.name] = ex.maxWeight;
    }
    });
    saveRecords(records, () => {
    refreshRecordHints();
    updateStats();
    updateProgressChart();
    });
    });

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    tg.showPopup({
    title: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!',
    message: `–¢–æ–Ω–Ω–∞–∂: ${workoutData.totalVolume} –∫–≥\n–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: ${workoutData.totalReps}`,
    buttons: [{type: 'ok'}]
    });

    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    setTimeout(() => {
    document.getElementById('supersets-container').innerHTML = '';
    currentSupersetCount = 0;
    buildInitialItems();
    }, 800);
    }

    function updateHistory() {
    const container = document.getElementById('history-container');

    loadFromCloud((workouts) => {
    if (!workouts || workouts.length === 0) {
    container.innerHTML = `
    <div class="empty-state">
    <div class="empty-state-icon">üìã</div>
    <div>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
    </div>
    `;
    return;
    }

    let html = '';
    workouts.slice().reverse().forEach((workout, index) => {
    const realIndex = workouts.length - 1 - index;
    const date = new Date(workout.date);
    const dateStr = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });

    html += `
    <div class="history-item">
    <div class="history-date">${dateStr}</div>
    <div class="history-stats">
    <span>üí™ ${workout.exercises.length} —É–ø—Ä.</span>
    <span>‚öñÔ∏è ${workout.totalVolume} –∫–≥</span>
    <span>üîÑ ${workout.totalReps} –ø–æ–≤—Ç.</span>
    </div>
    <button class="btn btn-small" style="margin-top: 10px;" onclick="viewWorkout(${realIndex})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
    </div>
    `;
    });

    container.innerHTML = html;
    });
    }

    function viewWorkout(index) {
    loadFromCloud((workouts) => {
    const workout = workouts[index];
    if (!workout) return;

    let details = `üìÖ ${new Date(workout.date).toLocaleDateString('ru-RU')}\n\n`;

    let currentSupersetNum = 0;
    workout.exercises.forEach(exercise => {
    if (exercise.superset !== currentSupersetNum) {
    currentSupersetNum = exercise.superset;
    details += `\nüîÑ –°—É–ø–µ—Ä—Å–µ—Ç ${currentSupersetNum}:\n`;
    }

    const prMark = records[exercise.name] && exercise.maxWeight >= records[exercise.name] ? ' üèÜ' : '';
    details += `${exercise.name}${prMark}:\n`;
    details += exercise.sets.map((set, i) => `  ${i+1}. ${set.weight}–∫–≥ √ó ${set.reps}`).join('\n');
    details += `\n  üí™ –û–±—ä–µ–º: ${exercise.volume}–∫–≥  |  –ú–∞–∫—Å: ${exercise.maxWeight}–∫–≥\n`;
    });

    details += `\nüìä –ò—Ç–æ–≥–æ:\n`;
    details += `‚öñÔ∏è –¢–æ–Ω–Ω–∞–∂: ${workout.totalVolume} –∫–≥\n`;
    details += `üîÑ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: ${workout.totalReps}`;

    tg.showPopup({
    title: '–î–µ—Ç–∞–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
    message: details,
    buttons: [{type: 'ok'}]
    });
    });
    }

    function updateStats() {
    loadFromCloud((workouts) => {
    if (!workouts) workouts = [];

    const totalWorkouts = workouts.length;
    const totalVolume = workouts.reduce((sum, w) => sum + w.totalVolume, 0);
    const avgVolume = totalWorkouts > 0 ? Math.round(totalVolume / totalWorkouts) : 0;

    // –ü–æ–¥—Å—á–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
    const exerciseCount = {};
    workouts.forEach(workout => {
    workout.exercises.forEach(ex => {
    exerciseCount[ex.name] = (exerciseCount[ex.name] || 0) + 1;
    });
    });

    const totalExercises = Object.keys(exerciseCount).length;

    document.getElementById('total-workouts').textContent = totalWorkouts;
    document.getElementById('total-volume').textContent = totalVolume > 1000 ?
    (totalVolume / 1000).toFixed(1) + '—Ç' : totalVolume;
    document.getElementById('avg-volume').textContent = avgVolume;
    document.getElementById('total-exercises').textContent = totalExercises;

    // –¢–æ–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
    const topExercises = Object.entries(exerciseCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);

    const topExercisesHtml = topExercises.map(([name, count]) => `
    <div class="exercise-item">
    <span>${name}</span>
    <span>${count} —Ä–∞–∑</span>
    </div>
    `).join('');

    document.getElementById('top-exercises').innerHTML = topExercisesHtml ||
    '<div class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

    // –†–µ–∫–æ—Ä–¥—ã
    loadRecords((recs) => {
    records = recs || {};
    const recEntries = Object.entries(records)
    .sort((a,b) => b[1] - a[1]); // –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Ä–µ–∫–æ—Ä–¥–∞

    document.getElementById('records-list').innerHTML = recEntries.length ? recEntries.map(([name, w]) => `
    <div class="exercise-item">
    <span>${name}</span>
    <span>üèÜ ${w} –∫–≥</span>
    </div>
    `).join('') : '<div class="empty-state">–†–µ–∫–æ—Ä–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';

    populateProgressExerciseSelect();
    refreshRecordHints();
    });
    });
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c]));
    }

    function addExercise() {
    const input = document.getElementById('new-exercise');
    const exerciseName = input.value.trim();

    if (exerciseName && !exercises.includes(exerciseName)) {
    exercises.push(exerciseName);
    exercises.sort();
    saveExercises();
    updateExercisesList();
    populateProgressExerciseSelect();
    input.value = '';

    tg.showPopup({
    title: '–£—Å–ø–µ—à–Ω–æ!',
    message: '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ',
    buttons: [{type: 'ok'}]
    });

    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    }
    }

    function updateExercisesList() {
    const list = document.getElementById('exercises-list');
    list.innerHTML = '';
    exercises.forEach(ex => {
      const item = document.createElement('div');
      item.className = 'exercise-item';
      const span = document.createElement('span');
      span.textContent = ex;
      const btn = document.createElement('button');
      btn.className = 'btn btn-small btn-danger';
      btn.textContent = '‚úï';
      btn.addEventListener('click', () => removeExercise(ex));
      item.append(span, btn);
      list.appendChild(item);
    });
    }

    function removeExercise(name) {
    tg.showConfirm(`–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${name}"?`, (confirmed) => {
    if (confirmed) {
    exercises = exercises.filter(ex => ex !== name);
    saveExercises();
    updateExercisesList();
    populateProgressExerciseSelect();
    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
    }
    });
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    function populateProgressExerciseSelect() {
    const sel = document.getElementById('progress-exercise-select');
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>' + optionsHtml(exercises);
    if (current && exercises.includes(current)) sel.value = current;
    }

    // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –æ —Ä–µ–∫–æ—Ä–¥–µ –ø–æ–¥ select
    function refreshRecordHints() {
    document.querySelectorAll('.exercise-block').forEach(block => {
    const select = block.querySelector('.exercise-select');
    const hint = block.querySelector('.record-hint');
    if (!select || !hint) return;
    const name = select.value;
    if (name && records[name]) {
    hint.textContent = `–¢–µ–∫—É—â–∏–π —Ä–µ–∫–æ—Ä–¥: ${records[name]} –∫–≥`;
    } else if (name) {
    hint.textContent = '–†–µ–∫–æ—Ä–¥ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
    } else {
    hint.textContent = '';
    }
    });
    }

    // –ü—Ä–æ—Å—Ç–æ–π —Ä–µ–Ω–¥–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ canvas (–º–∞–∫—Å. –≤–µ—Å –ø–æ –¥–∞—Ç–∞–º)
    function updateProgressChart() {
    const exerciseName = document.getElementById('progress-exercise-select')?.value || '';
    const canvas = document.getElementById('progress-canvas');
    const empty = document.getElementById('progress-empty');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // –û—á–∏—Å—Ç–∫–∞
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (!exerciseName) {
    empty.style.display = 'block';
    empty.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
    return;
    }

    loadFromCloud((workouts) => {
    const points = [];
    (workouts || []).forEach(w => {
    const entry = w.exercises.find(e => e.name === exerciseName);
    if (entry) {
    points.push({ date: new Date(w.date), value: entry.maxWeight || 0 });
    }
    });

    points.sort((a,b) => a.date - b.date);

    if (points.length === 0) {
    empty.style.display = 'block';
    empty.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è';
    return;
    } else {
    empty.style.display = 'none';
    }

    // –ü–∞–¥–¥–∏–Ω–≥–∏ –∏ –æ—Å–∏
    const padLeft = 40, padRight = 10, padTop = 10, padBottom = 30;
    const W = canvas.width, H = canvas.height;
    const plotW = W - padLeft - padRight;
    const plotH = H - padTop - padBottom;

    const minVal = 0;
    const maxVal = Math.max(...points.map(p => p.value));
    const valRange = Math.max(1, maxVal - minVal);

    const minDate = points[0].date.getTime();
    const maxDate = points[points.length - 1].date.getTime();
    const dateRange = Math.max(1, maxDate - minDate);

    // –û—Å–∏
    ctx.strokeStyle = '#aaa';
    ctx.lineWidth = 1;
    // Y axis
    ctx.beginPath();
    ctx.moveTo(padLeft, padTop);
    ctx.lineTo(padLeft, H - padBottom);
    ctx.stroke();
    // X axis
    ctx.beginPath();
    ctx.moveTo(padLeft, H - padBottom);
    ctx.lineTo(W - padRight, H - padBottom);
    ctx.stroke();

    // –°–µ—Ç–∫–∏ –∏ –º–µ—Ç–∫–∏ –ø–æ Y (4 –¥–µ–ª–µ–Ω–∏—è)
    ctx.fillStyle = '#666';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    const ticks = 4;
    for (let i = 0; i <= ticks; i++) {
    const v = minVal + (valRange * i / ticks);
    const y = padTop + plotH - (plotH * (v - minVal) / valRange);
    ctx.strokeStyle = '#eee';
    ctx.beginPath();
    ctx.moveTo(padLeft, y);
    ctx.lineTo(W - padRight, y);
    ctx.stroke();
    ctx.fillStyle = '#666';
    ctx.fillText(Math.round(v).toString(), padLeft - 6, y);
    }

    // –ü–æ–¥–ø–∏—Å–∏ –ø–æ X: –ø–µ—Ä–≤–∞—è –∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.fillStyle = '#666';
    const firstDateStr = new Date(minDate).toLocaleDateString('ru-RU');
    const lastDateStr = new Date(maxDate).toLocaleDateString('ru-RU');
    ctx.fillText(firstDateStr, padLeft, H - padBottom + 6);
    ctx.fillText(lastDateStr, W - padRight, H - padBottom + 6);

    // –õ–∏–Ω–∏—è
    ctx.strokeStyle = '#667eea';
    ctx.lineWidth = 2;
    ctx.beginPath();
    points.forEach((p, idx) => {
    const x = padLeft + (plotW * (p.date.getTime() - minDate) / dateRange);
    const y = padTop + plotH - (plotH * (p.value - minVal) / valRange);
    if (idx === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // –¢–æ—á–∫–∏
    ctx.fillStyle = '#764ba2';
    points.forEach(p => {
    const x = padLeft + (plotW * (p.date.getTime() - minDate) / dateRange);
    const y = padTop + plotH - (plotH * (p.value - minVal) / valRange);
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI * 2);
    ctx.fill();
    });
    });
    }

    // Retina scaling
    function resizeCanvasToDevicePixelRatio(canvas, cssW = canvas.clientWidth, cssH = canvas.clientHeight) {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.round(cssW * dpr);
      canvas.height = Math.round(cssH * dpr);
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    // –†–∞–±–æ—Ç–∞ —Å CloudStorage (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)
    function saveToCloud(workoutData, cb) {
    const key = 'workouts';
    tg.CloudStorage.getItem(key, (error, value) => {
    let workouts = [];
    if (value) {
    try { workouts = JSON.parse(value); } catch (e) { console.error('Error parsing workouts:', e); }
    } else {
    // fallback local
    const local = localStorage.getItem(key);
    if (local) { try { workouts = JSON.parse(local); } catch (e) {} }
    }

    workouts.push(workoutData);
    if (workouts.length > 100) workouts = workouts.slice(-100);

    tg.CloudStorage.setItem(key, JSON.stringify(workouts), (err) => {
    if (err) {
    console.error('Error saving to cloud:', err);
    localStorage.setItem(key, JSON.stringify(workouts));
    }
    if (typeof cb === 'function') cb();
    });
    });
    }

    function loadFromCloud(callback) {
    const key = 'workouts';
    tg.CloudStorage.getItem(key, (error, value) => {
    if (error) {
    const localData = localStorage.getItem(key);
    if (localData) {
    try { callback(JSON.parse(localData)); } catch (e) { callback([]); }
    } else {
    callback([]);
    }
    } else {
    if (value) {
    try { callback(JSON.parse(value)); } catch (e) { callback([]); }
    } else {
    callback([]);
    }
    }
    });
    }

    // –†–µ–∫–æ—Ä–¥—ã
    function saveRecords(recs, cb) {
    tg.CloudStorage.setItem('records', JSON.stringify(recs), (error) => {
    if (error) localStorage.setItem('records', JSON.stringify(recs));
    if (typeof cb === 'function') cb();
    });
    }

    function loadRecords(callback) {
    tg.CloudStorage.getItem('records', (error, value) => {
    if (value) {
    try { callback(JSON.parse(value)); return; } catch (e) {}
    }
    const local = localStorage.getItem('records');
    if (local) {
    try { callback(JSON.parse(local)); return; } catch (e) {}
    }
    callback({});
    });
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    function changeMode(newMode) {
    settings.mode = newMode === 'single' ? 'single' : 'superset';
    saveSettings(settings, () => {
    updateModeUI();
    buildInitialItems();
    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    });
    }

    function saveSettings(s, cb) {
    tg.CloudStorage.setItem('settings', JSON.stringify(s), (error) => {
    if (error) localStorage.setItem('settings', JSON.stringify(s));
    if (typeof cb === 'function') cb();
    });
    }

    function loadSettings(callback) {
    tg.CloudStorage.getItem('settings', (error, value) => {
    if (value) {
    try { settings = JSON.parse(value); } catch (e) {}
    } else {
    const local = localStorage.getItem('settings');
    if (local) { try { settings = JSON.parse(local); } catch (e) {} }
    }
    if (!settings || !settings.mode) settings = { mode: 'superset' };
    callback();
    });
    }

    function saveExercises() {
    tg.CloudStorage.setItem('exercises', JSON.stringify(exercises), (error) => {
    if (error) localStorage.setItem('exercises', JSON.stringify(exercises));
    });
    }

    function loadData() {
    // –ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
    return new Promise((resolve) => {
    tg.CloudStorage.getItem('exercises', (error, value) => {
    if (value) {
    try { exercises = JSON.parse(value); } catch (e) { console.error('Error parsing exercises:', e); }
    } else {
    const localExercises = localStorage.getItem('exercises');
    if (localExercises) {
    try { exercises = JSON.parse(localExercises); } catch (e) { console.error('Error parsing local exercises:', e); }
    }
    }
    resolve();
    });
    });
    }

    function loadAll(done) {
    loadData().then(() => {
    loadSettings(() => {
    loadRecords((recs) => {
    records = recs || {};
    if (typeof done === 'function') done();
    });
    });
    });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
    tg.BackButton.onClick(() => {
    tg.close();
    });

    function goBack() {
      if (window.Telegram?.WebApp?.close) {
        window.Telegram.WebApp.close();
      } else {
        history.back();
      }
    }
    </script>
</body>
</html>
