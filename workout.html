<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–¢—Ä–µ–∫–µ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0f1115; --card:#171a21; --card2:#131720; --text:#e6e9ef; --muted:#9aa4b2; --line:#2a2f3a; --acc:#4f8cff; --danger:#ef4444; }
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); padding-bottom:72px; }
    header { position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--line); padding:12px; }
    h1 { margin:0; font-size:18px; }
    .muted { color:var(--muted); font-size:13px; }
    .controls { margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="date"] { background:var(--card2); border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:8px; }
    button { background:var(--acc); color:#fff; border:none; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; }
    button.ghost { background:transparent; border:1px solid var(--line); color:var(--text); }
    button.danger { background:var(--danger); }
    .tabs { margin-top:10px; display:flex; gap:8px; }
    .tab-btn { background:transparent; border:1px solid var(--line); color:var(--text); padding:8px 12px; border-radius:999px; font-weight:600; cursor:pointer; }
    .tab-btn.active { background:var(--acc); border-color:var(--acc); }
    main { padding:12px; }
    .tab { display:none; } .tab.active { display:block; }

    /* Workout tab */
    .stats { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px; margin-bottom:12px; }
    .stat { background:var(--card2); border:1px solid var(--line); border-radius:10px; padding:10px 12px; text-align:center; }
    .stat h3 { margin:0; font-size:13px; color:var(--muted); }
    .stat p { margin:4px 0 0; font-size:16px; font-weight:700; }
    .hint { font-size:12px; color:var(--muted); margin:8px 0; }
    .blocks { display:grid; gap:12px; }
    .block { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px; }
    .block-header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; border-bottom:1px solid var(--line); padding-bottom:6px; }
    .block-title { font-weight:700; font-size:15px; }
    .block-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .subex { background:var(--card2); border:1px dashed var(--line); border-radius:10px; padding:8px; margin-top:8px; }
    .subex-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    .subex-row input[name="exName"] { flex:1; background:#0f1320; border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:8px; font-weight:600; }
    .sets { display:grid; grid-template-columns:repeat(auto-fill, minmax(140px,1fr)); gap:8px; }
    .set { background:#101522; border:1px solid var(--line); border-radius:8px; padding:8px; position:relative; }
    .set .num { font-size:11px; color:var(--muted); margin-bottom:6px; text-align:center; }
    .set .row { display:flex; gap:6px; }
    .set input { width:100%; background:#0f1320; border:1px solid var(--line); color:var(--text); padding:6px 8px; border-radius:6px; text-align:center; }
    .set .rm { position:absolute; top:6px; right:6px; background:var(--danger); color:#fff; border:none; width:22px; height:22px; border-radius:50%; font-weight:800; cursor:pointer; }
    .page-actions { display:flex; gap:8px; position:fixed; left:0; right:0; bottom:0; background:var(--card); border-top:1px solid var(--line); padding:8px 12px; z-index:9; }
    .page-actions button { flex:1; }
    @media (max-width:420px){ .stats{ grid-template-columns:1fr 1fr; } }
    datalist option { color:#000; }

    /* Stats tab */
    .stat-cards { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin-bottom:12px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; }
    .card h3 { margin:0 0 8px; font-size:14px; color:var(--muted); }
    .metric { font-size:18px; font-weight:700; }
    .list { display:grid; gap:8px; }
    .list-item { background:var(--card2); border:1px solid var(--line); border-radius:8px; padding:8px; display:flex; align-items:center; justify-content:space-between; }
    .chart-area { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; margin-top:12px; }
    .chart-header { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .chart-header select { flex:1; background:#0f1320; border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:8px; }
    canvas { width:100%; height:220px; background:#0f1320; border:1px solid var(--line); border-radius:8px; }
    .empty { color:var(--muted); text-align:center; padding:16px 8px; }
  </style>
</head>
<body>
  <header>
    <h1>–¢—Ä–µ–∫–µ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h1>
    <div class="muted">–û–¥–∏–Ω –¥–µ–Ω—å = –æ–¥–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Telegram CloudStorage</div>

    <div class="controls" id="controls-workout">
      <label for="date">–î–∞—Ç–∞:</label>
      <input type="date" id="date" />
      <button id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="clear" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å –¥–µ–Ω—å</button>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="workout">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
      <button class="tab-btn" data-tab="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>
  </header>

  <main>
    <!-- –í–∫–ª–∞–¥–∫–∞: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ -->
    <section id="tab-workout" class="tab active">
      <div class="stats">
        <div class="stat"><h3>–¢–æ–Ω–Ω–∞–∂</h3><p id="statVolume">0 –∫–≥</p></div>
        <div class="stat"><h3>–ü–æ–≤—Ç–æ—Ä—ã</h3><p id="statReps">0</p></div>
        <div class="stat"><h3>–ú–∞–∫—Å. –≤–µ—Å</h3><p id="statMax">0 –∫–≥</p></div>
      </div>

      <div class="hint">–î–æ–±–∞–≤–ª—è–π —Å—É–ø–µ—Ä—Å–µ—Ç—ã –∏–ª–∏ –æ–¥–∏–Ω–æ—á–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è. –í –∫–∞–∂–¥–æ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–∏ —É–∫–∞–∂–∏ –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

      <div id="blocks" class="blocks"></div>
    </section>

    <!-- –í–∫–ª–∞–¥–∫–∞: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <section id="tab-stats" class="tab">
      <div class="stat-cards">
        <div class="card">
          <h3>–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
          <div class="metric" id="st-total-workouts">0</div>
        </div>
        <div class="card">
          <h3>–û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂</h3>
          <div class="metric" id="st-total-volume">0 –∫–≥</div>
        </div>
        <div class="card">
          <h3>–°—Ä–µ–¥–Ω–∏–π —Ç–æ–Ω–Ω–∞–∂</h3>
          <div class="metric" id="st-avg-volume">0 –∫–≥</div>
        </div>
        <div class="card">
          <h3>–õ—É—á—à–∏–π –¥–µ–Ω—å (—Ç–æ–Ω–Ω–∞–∂)</h3>
          <div class="metric" id="st-best-volume">0 –∫–≥</div>
        </div>
      </div>

      <div class="card">
        <h3>–¢–æ–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</h3>
        <div class="list" id="st-top-exercises"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>–†–µ–∫–æ—Ä–¥—ã (–º–∞–∫—Å. –≤–µ—Å)</h3>
        <div class="list" id="st-records"></div>
      </div>

      <div class="chart-area">
        <div class="chart-header">
          <select id="st-exercise-select"></select>
        </div>
        <canvas id="st-canvas" width="600" height="220"></canvas>
        <div id="st-empty" class="empty" style="display:none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>
      </div>
    </section>
  </main>

  <!-- –ö–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞) -->
  <div class="page-actions" id="page-actions">
    <button id="addSingle" class="ghost">+ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
    <button id="addSuperset" class="ghost">+ –°—É–ø–µ—Ä—Å–µ—Ç</button>
  </div>

 <datalist id="exercise-suggestions">
  <!-- –ì—Ä—É–¥—å -->
  <option value="–ñ–∏–º –ª—ë–∂–∞ —à—Ç–∞–Ω–≥–∞"></option>
  <option value="–ñ–∏–º –ª—ë–∂–∞ –≥–∞–Ω—Ç–µ–ª–∏"></option>
  <option value="–ñ–∏–º –Ω–∞ –Ω–∞–∫–ª–æ–Ω–Ω–æ–π —Å–∫–∞–º—å–µ —à—Ç–∞–Ω–≥–∞"></option>
  <option value="–ñ–∏–º –Ω–∞ –Ω–∞–∫–ª–æ–Ω–Ω–æ–π —Å–∫–∞–º—å–µ –≥–∞–Ω—Ç–µ–ª–∏"></option>
  <option value="–†–∞–∑–≤–æ–¥–∫–∞ –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞"></option>
  <option value="–°–≤–µ–¥–µ–Ω–∏–µ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ (–±–∞–±–æ—á–∫–∞)"></option>
  <option value="–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞"></option>
  <option value="–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö (–≥—Ä—É–¥—å)"></option>

  <!-- –°–ø–∏–Ω–∞ -->
  <option value="–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è —à–∏—Ä–æ–∫–∏–º —Ö–≤–∞—Ç–æ–º"></option>
  <option value="–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è —É–∑–∫–∏–º —Ö–≤–∞—Ç–æ–º"></option>
  <option value="–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞"></option>
  <option value="–¢—è–≥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞"></option>
  <option value="–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ"></option>
  <option value="–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ"></option>
  <option value="–¢—è–≥–∞ –¢-–≥—Ä–∏—Ñ–∞"></option>
  <option value="–ü—É–ª–æ–≤–µ—Ä —Å –≥–∞–Ω—Ç–µ–ª—å—é"></option>
  <option value="–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è"></option>

  <!-- –ù–æ–≥–∏ -->
  <option value="–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å–æ —à—Ç–∞–Ω–≥–æ–π"></option>
  <option value="–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏"></option>
  <option value="–§—Ä–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è"></option>
  <option value="–ñ–∏–º –Ω–æ–≥–∞–º–∏"></option>
  <option value="–í—ã–ø–∞–¥—ã —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏"></option>
  <option value="–ë–æ–ª–≥–∞—Ä—Å–∫–∏–µ —Å–ø–ª–∏—Ç-–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è"></option>
  <option value="–°–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥ –ª—ë–∂–∞"></option>
  <option value="–†–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥ —Å–∏–¥—è"></option>
  <option value="–ü–æ–¥—ä—ë–º –Ω–∞ –Ω–æ—Å–∫–∏ —Å—Ç–æ—è (–∏–∫—Ä—ã)"></option>
  <option value="–ü–æ–¥—ä—ë–º –Ω–∞ –Ω–æ—Å–∫–∏ —Å–∏–¥—è (–∏–∫—Ä—ã)"></option>
  <option value="–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞ —Å–æ —à—Ç–∞–Ω–≥–æ–π"></option>
  <option value="–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞ —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏"></option>

  <!-- –ü–ª–µ—á–∏ -->
  <option value="–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è"></option>
  <option value="–ñ–∏–º —à—Ç–∞–Ω–≥–∏ —Å—Ç–æ—è"></option>
  <option value="–ú–∞—Ö–∏ –≥–∞–Ω—Ç–µ–ª—è–º–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—ã"></option>
  <option value="–ú–∞—Ö–∏ –≥–∞–Ω—Ç–µ–ª—è–º–∏ –≤–ø–µ—Ä—ë–¥"></option>
  <option value="–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –∫ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É"></option>
  <option value="–û–±—Ä–∞—Ç–Ω—ã–µ –º–∞—Ö–∏ (–∑–∞–¥–Ω—è—è –¥–µ–ª—å—Ç–∞)"></option>
  <option value="–¢—è–≥–∞ –∫–∞–Ω–∞—Ç–∞ –∫ –ª–∏—Ü—É (Face Pull)"></option>

  <!-- –†—É–∫–∏ -->
  <option value="–ü–æ–¥—ä—ë–º —à—Ç–∞–Ω–≥–∏ –Ω–∞ –±–∏—Ü–µ–ø—Å"></option>
  <option value="–ü–æ–¥—ä—ë–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞ –±–∏—Ü–µ–ø—Å"></option>
  <option value="–ú–æ–ª–æ—Ç–∫–∏ —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏"></option>
  <option value="–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º —à—Ç–∞–Ω–≥–∏"></option>
  <option value="–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º –≥–∞–Ω—Ç–µ–ª–∏"></option>
  <option value="–†–∞–∑–≥–∏–±–∞–Ω–∏—è —Ä—É–∫ –Ω–∞ –±–ª–æ–∫–µ (—Ç—Ä–∏—Ü–µ–ø—Å)"></option>
  <option value="–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö (—Ç—Ä–∏—Ü–µ–ø—Å)"></option>

  <!-- –ü—Ä–µ—Å—Å -->
  <option value="–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è –Ω–∞ –ø–æ–ª—É"></option>
  <option value="–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è –Ω–∞ —Ñ–∏—Ç–±–æ–ª–µ"></option>
  <option value="–ü–æ–¥—ä—ë–º –Ω–æ–≥ –≤ –≤–∏—Å–µ"></option>
  <option value="–ü–ª–∞–Ω–∫–∞"></option>
  <option value="–í–µ–ª–æ—Å–∏–ø–µ–¥ (–ø—Ä–µ—Å—Å)"></option>
  <option value="–†—É—Å—Å–∫–∏–π —Ç–≤–∏—Å—Ç"></option>
</datalist>

  <template id="set-template">
    <div class="set">
      <div class="num">–ü–æ–¥—Ö–æ–¥ 1</div>
      <div class="row">
        <input class="w" type="number" step="0.5" placeholder="–∫–≥" />
        <input class="r" type="number" placeholder="–ø–æ–≤—Ç" />
      </div>
      <button class="rm" type="button">√ó</button>
    </div>
  </template>

  <script>
    // Telegram init
    const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
    if (tg.setHeaderColor) tg.setHeaderColor('#171a21');
    if (tg.setBackgroundColor) tg.setBackgroundColor('#0f1115');

    // Helpers
    const qs = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
    const $date = qs('#date'), $blocks = qs('#blocks'), $pageActions = qs('#page-actions');
    let blockCounter = 0, workoutsCache = [];

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function todayISO(){ const d=new Date(), off=d.getTimezoneOffset()*60000; return new Date(Date.now()-off).toISOString().slice(0,10); }
    function haptic(type='light'){ if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred(type); }

    // Tabs
    qsa('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab, btn)));
    function switchTab(tab, btn){
      qsa('.tab-btn').forEach(b=>b.classList.remove('active')); if (btn) btn.classList.add('active');
      qsa('.tab').forEach(t=>t.classList.remove('active')); qs('#tab-'+tab).classList.add('active');
      qs('#controls-workout').style.display = tab==='workout' ? 'flex' : 'none';
      $pageActions.style.display = tab==='workout' ? 'flex' : 'none';
      if (tab==='stats') renderStatsTab();
      haptic('light');
    }

    // Workout UI
    function renumberSets(c){ qsa('.set', c).forEach((el,i)=> el.querySelector('.num').textContent = `–ü–æ–¥—Ö–æ–¥ ${i+1}`); }
    function updateStats(){
      let volume=0,reps=0,maxW=0;
      qsa('.set').forEach(s=>{
        const w=parseFloat(qs('.w',s).value)||0, r=parseInt(qs('.r',s).value)||0;
        if(w>0&&r>0){ volume+=w*r; reps+=r; if(w>maxW) maxW=w; }
      });
      qs('#statVolume').textContent = `${Math.round(volume)} –∫–≥`;
      qs('#statReps').textContent = `${reps}`;
      qs('#statMax').textContent = `${maxW} –∫–≥`;
    }
    function createSet(v={}){
      const tpl = qs('#set-template').content.cloneNode(true);
      const s = tpl.querySelector('.set');
      const w = qs('.w', s), r = qs('.r', s);
      if(v.weight!=null) w.value=v.weight; if(v.reps!=null) r.value=v.reps;
      w.addEventListener('input', updateStats); r.addEventListener('input', updateStats);
      qs('.rm', s).addEventListener('click', () => { const p=s.parentElement; s.remove(); renumberSets(p); updateStats(); haptic('light'); });
      return s;
    }
    function subExerciseTemplate(title='–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', suggested=true){
      const sub = document.createElement('div'); sub.className='subex';
      sub.innerHTML = `
        <div class="subex-row">
          <input name="exName" placeholder="${title}" ${suggested?'list="exercise-suggestions"':''} />
          <button class="ghost addSet" type="button">+ –ø–æ–¥—Ö–æ–¥</button>
        </div>
        <div class="sets"></div>`;
      const sets = qs('.sets', sub);
      for(let i=0;i<3;i++) sets.appendChild(createSet());
      renumberSets(sets); updateStats();
      qs('.addSet', sub).addEventListener('click', ()=>{ sets.appendChild(createSet()); renumberSets(sets); updateStats(); haptic('light'); });
      return sub;
    }
    function addBlock(type='single'){
      blockCounter+=1; const idx=blockCounter;
      const b=document.createElement('div'); b.className='block'; b.dataset.superset=String(idx);
      b.innerHTML = `
        <div class="block-header">
          <div class="block-title">${type==='superset'?'–°—É–ø–µ—Ä—Å–µ—Ç':'–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ'} ${idx}</div>
          <div class="block-actions">
            <button class="ghost addSetAll" type="button">+ –ø–æ–¥—Ö–æ–¥</button>
            <button class="danger removeBlock" type="button">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>`;
      if(type==='superset'){ b.appendChild(subExerciseTemplate('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 1')); b.appendChild(subExerciseTemplate('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 2')); }
      else { b.appendChild(subExerciseTemplate('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ')); }
      qs('.removeBlock', b).addEventListener('click', ()=>{ b.remove(); renumberBlocks(); updateStats(); haptic('medium'); });
      qs('.addSetAll', b).addEventListener('click', ()=>{ qsa('.subex', b).forEach(se=>{ const sets=qs('.sets',se); sets.appendChild(createSet()); renumberSets(sets); }); updateStats(); haptic('light'); });
      $blocks.appendChild(b); haptic('light');
    }
    function renumberBlocks(){
      let i=1; qsa('.block').forEach(b=>{ b.dataset.superset=String(i); const t=qs('.block-title',b);
        t.textContent = (t.textContent.startsWith('–°—É–ø–µ—Ä—Å–µ—Ç')?'–°—É–ø–µ—Ä—Å–µ—Ç ':'–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ') + i; i++; });
    }

    // Data mapping
    function collectWorkoutData(){
      const data={ date:$date.value, exercises:[], totalVolume:0, totalReps:0, userId: tg.initDataUnsafe?.user?.id || 'local' };
      qsa('.block').forEach((block, bi)=>{
        const sup = bi+1;
        qsa('.subex', block).forEach(sub=>{
          const name = qs('input[name="exName"]', sub).value.trim();
          if(!name) return;
          const sets=[]; let exVol=0, exReps=0, maxW=0;
          qsa('.set', sub).forEach(s=>{
            const w=parseFloat(qs('.w',s).value)||0, r=parseInt(qs('.r',s).value)||0;
            if(w>0&&r>0){ sets.push({weight:w,reps:r}); exVol+=w*r; exReps+=r; if(w>maxW) maxW=w; }
          });
          if(sets.length){ data.exercises.push({ superset:sup, name, sets, volume:Math.round(exVol), totalReps:exReps, maxWeight:maxW });
            data.totalVolume+=exVol; data.totalReps+=exReps; }
        });
      });
      data.totalVolume=Math.round(data.totalVolume);
      return data;
    }
    function populateFromWorkout(w){
      $blocks.innerHTML=''; blockCounter=0;
      const bySup={}; (w.exercises||[]).forEach(ex=>{ (bySup[ex.superset] ||= []).push(ex); });
      const keys=Object.keys(bySup).map(n=>+n).sort((a,b)=>a-b);
      if(!keys.length){ addBlock('superset'); addBlock('single'); updateStats(); return; }
      keys.forEach(k=>{
        const group=bySup[k]; const type = group.length>=2 ? 'superset' : 'single';
        addBlock(type);
        const block = qsa('.block').slice(-1)[0];
        const subs = qsa('.subex', block);
        group.forEach((ex,i)=>{
          const sub = subs[i] || subs[0];
          qs('input[name="exName"]', sub).value = ex.name||'';
          const sets = qs('.sets', sub); sets.innerHTML='';
          (ex.sets||[]).forEach(s=> sets.appendChild(createSet({weight:s.weight, reps:s.reps})));
          renumberSets(sets);
        });
      });
      updateStats();
    }

    // CloudStorage
    function loadFromCloud(cb){
      tg.CloudStorage.getItem('workouts', (err, value)=>{
        if(err){ try{ const local=localStorage.getItem('workouts'); if(local){ const arr=JSON.parse(local); workoutsCache=arr.slice(); return cb(arr); } }catch(e){} workoutsCache=[]; return cb([]); }
        if(value){ try{ const arr=JSON.parse(value)||[]; workoutsCache=arr.slice(); return cb(arr); }catch(e){ workoutsCache=[]; return cb([]); } }
        workoutsCache=[]; cb([]);
      });
    }
    function saveToCloud(workout, cb){
      tg.CloudStorage.getItem('workouts', (err, value)=>{
        let arr=[]; if(value){ try{ arr=JSON.parse(value)||[]; }catch(e){ arr=[]; } }
        else { try{ const local=localStorage.getItem('workouts'); if(local) arr=JSON.parse(local)||[]; }catch(e){} }
        const i = arr.findIndex(w=>w.date===workout.date);
        if(i>=0) arr[i]=workout; else arr.push(workout);
        if(arr.length>300) arr=arr.slice(-300);
        tg.CloudStorage.setItem('workouts', JSON.stringify(arr), (e)=>{
          if(e){ try{ localStorage.setItem('workouts', JSON.stringify(arr)); }catch(_){} }
          workoutsCache=arr.slice(); if(cb) cb();
        });
      });
    }
    function clearDay(dateStr, cb){
      tg.CloudStorage.getItem('workouts', (err, value)=>{
        let arr=[]; if(value){ try{ arr=JSON.parse(value)||[]; }catch(e){ arr=[]; } }
        arr = arr.filter(w=>w.date!==dateStr);
        tg.CloudStorage.setItem('workouts', JSON.stringify(arr), (e)=>{
          if(e){ try{ localStorage.setItem('workouts', JSON.stringify(arr)); }catch(_){} }
          workoutsCache=arr.slice(); if(cb) cb();
        });
      });
    }

    // Load for date
    function loadForDate(dateStr){
      loadFromCloud(list=>{
        const w = (list||[]).find(x=>x.date===dateStr);
        if(w) populateFromWorkout(w);
        else { $blocks.innerHTML=''; blockCounter=0; addBlock('superset'); addBlock('single'); updateStats(); }
      });
    }

    // Stats tab
    function renderStatsTab(){
      loadFromCloud(list=>{
        const workouts=(list||[]).slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
        const total = workouts.length;
        const totalVol = workouts.reduce((s,w)=>s+(w.totalVolume||0),0);
        const avgVol = total ? Math.round(totalVol/total) : 0;
        const bestVol = workouts.reduce((m,w)=>Math.max(m,w.totalVolume||0),0);
        qs('#st-total-workouts').textContent = total;
        qs('#st-total-volume').textContent = `${Math.round(totalVol)} –∫–≥`;
        qs('#st-avg-volume').textContent = `${avgVol} –∫–≥`;
        qs('#st-best-volume').textContent = `${Math.round(bestVol)} –∫–≥`;

        const exCount={}, records={};
        workouts.forEach(w=> (w.exercises||[]).forEach(ex=>{
          exCount[ex.name]=(exCount[ex.name]||0)+1;
          records[ex.name]=Math.max(records[ex.name]||0, ex.maxWeight||0);
        }));
        const top = Object.entries(exCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
        qs('#st-top-exercises').innerHTML = top.length ? top.map(([n,c])=>`
          <div class="list-item"><span>${escapeHtml(n)}</span><span>${c} —Ä–∞–∑</span></div>`).join('') : '<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
        const recs = Object.entries(records).sort((a,b)=>b[1]-a[1]);
        qs('#st-records').innerHTML = recs.length ? recs.map(([n,w])=>`
          <div class="list-item"><span>${escapeHtml(n)}</span><span>üèÜ ${w} –∫–≥</span></div>`).join('') : '<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

        const names = Array.from(new Set(workouts.flatMap(w=>(w.exercises||[]).map(ex=>ex.name)))).sort();
        const sel = qs('#st-exercise-select'); const prev=sel.value;
        sel.innerHTML = names.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
        sel.value = (prev && names.includes(prev)) ? prev : (names[0]||'');
        drawProgressChart();
      });
    }

    function drawProgressChart(){
      const sel=qs('#st-exercise-select'), name=sel.value;
      const canvas=qs('#st-canvas'), empty=qs('#st-empty');
      // retina
      const cssW=canvas.clientWidth||600, cssH=canvas.clientHeight||220;
      const dpr=window.devicePixelRatio||1; canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr);
      const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,cssW,cssH);

      if(!name){ empty.style.display='block'; empty.textContent='–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ'; return; }
      empty.style.display='none';

      const workouts = workoutsCache.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
      const pts=[]; workouts.forEach(w=>{ const ex=(w.exercises||[]).find(e=>e.name===name); if(ex) pts.push({date:new Date(w.date), value:ex.maxWeight||0}); });
      if(!pts.length){ empty.style.display='block'; empty.textContent='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è'; return; }

      const padL=40, padR=10, padT=10, padB=30, W=cssW, H=cssH, PW=W-padL-padR, PH=H-padT-padB;
      const minV=0, maxV=Math.max(...pts.map(p=>p.value)), rangeV=Math.max(1,maxV-minV);
      const minT=pts[0].date.getTime(), maxT=pts[pts.length-1].date.getTime(), rangeT=Math.max(1,maxT-minT);

      // axes
      ctx.strokeStyle='#aaa'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,H-padB); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(padL,H-padB); ctx.lineTo(W-padR,H-padB); ctx.stroke();

      // grid Y
      ctx.font='12px sans-serif'; ctx.fillStyle='#666'; ctx.textAlign='right'; ctx.textBaseline='middle';
      const ticks=4; for(let i=0;i<=ticks;i++){ const v=minV+rangeV*i/ticks; const y=padT+PH-(PH*(v-minV)/rangeV);
        ctx.strokeStyle='#2a2f3a'; ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke(); ctx.fillText(String(Math.round(v)), padL-6, y); }

      // labels X
      ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillStyle='#666';
      const first=new Date(minT).toLocaleDateString('ru-RU'), last=new Date(maxT).toLocaleDateString('ru-RU');
      ctx.fillText(first, padL, H-padB+6); ctx.fillText(last, W-padR, H-padB+6);

      // line
      ctx.strokeStyle='#4f8cff'; ctx.lineWidth=2; ctx.beginPath();
      pts.forEach((p,i)=>{ const x=padL+PW*((p.date.getTime()-minT)/rangeT); const y=padT+PH-(PH*(p.value-minV)/rangeV);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.stroke();

      // points
      ctx.fillStyle='#9aa4b2';
      pts.forEach(p=>{ const x=padL+PW*((p.date.getTime()-minT)/rangeT); const y=padT+PH-(PH*(p.value-minV)/rangeV);
        ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
    }

    // Events
    qs('#addSingle').addEventListener('click', ()=> addBlock('single'));
    qs('#addSuperset').addEventListener('click', ()=> addBlock('superset'));

    qs('#save').addEventListener('click', ()=>{
      if(!$date.value) return tg.showAlert('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É');
      const data=collectWorkoutData();
      if(!data.exercises.length) return tg.showAlert('–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å –ø–æ–¥—Ö–æ–¥–∞–º–∏');
      saveToCloud(data, ()=>{
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        tg.showPopup({ title:'–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', message:`üìÖ ${new Date(data.date).toLocaleDateString('ru-RU')}\n‚öñÔ∏è ${data.totalVolume} –∫–≥ ‚Ä¢ üîÑ ${data.totalReps} –ø–æ–≤—Ç.`, buttons:[{type:'ok'}] });
      });
    });

    qs('#clear').addEventListener('click', ()=>{
      if(!$date.value) return tg.showAlert('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É');
      tg.showConfirm(`–û—á–∏—Å—Ç–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∑–∞ ${new Date($date.value).toLocaleDateString('ru-RU')}?`, ok=>{
        if(!ok) return;
        clearDay($date.value, ()=>{
          $blocks.innerHTML=''; blockCounter=0; addBlock('superset'); addBlock('single'); updateStats(); tg.showAlert('–î–µ–Ω—å –æ—á–∏—â–µ–Ω');
        });
      });
    });

    $date.addEventListener('change', e=> loadForDate(e.target.value));
    qs('#st-exercise-select').addEventListener('change', drawProgressChart);

    // Init
    $date.value = todayISO();
    loadForDate($date.value);
  </script>
</body>
</html>
