<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Трекер тренировок</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg:#0f1115; --card:#171a21; --card2:#131720; --text:#e6e9ef; --muted:#9aa4b2;
      --line:#2a2f3a; --acc:#4f8cff; --danger:#ef4444; --ok:#22c55e;
    }
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); padding-bottom:84px; }
    header { position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--line); padding:12px; }
    h1 { margin:0; font-size:18px; }
    .muted { color:var(--muted); font-size:13px; }
    .controls { margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="date"] { background:var(--card2); border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:8px; }
    button { background:var(--acc); color:#fff; border:none; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; }
    button.ghost { background:transparent; border:1px solid var(--line); color:var(--text); }
    button.danger { background:var(--danger); }
    main { padding:12px; }
    .tabs { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .tab-btn { background:transparent; border:1px solid var(--line); color:var(--text); padding:8px 12px; border-radius:999px; font-weight:600; cursor:pointer; }
    .tab-btn.active { background:var(--acc); border-color:var(--acc); }
    .tab { display:none; } .tab.active { display:block; }

    /* Workout tab */
    .stats { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px; margin-bottom:12px; }
    .stat { background:var(--card2); border:1px solid var(--line); border-radius:10px; padding:10px 12px; text-align:center; }
    .stat h3 { margin:0; font-size:13px; color:var(--muted); }
    .stat p { margin:4px 0 0; font-size:16px; font-weight:700; }
    .hint { font-size:12px; color:var(--muted); margin:8px 0; }
    .blocks { display:grid; gap:12px; }
    .block { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px; }
    .block-header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; border-bottom:1px solid var(--line); padding-bottom:6px; }
    .block-title { font-weight:700; font-size:15px; }
    .block-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .subex { background:var(--card2); border:1px dashed var(--line); border-radius:10px; padding:8px; margin-top:8px; }
    .subex-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    .subex-row input[name="exName"] { flex:1; background:#0f1320; border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:8px; font-weight:600; }
    .sets { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); gap:8px; }
    .set { background:#101522; border:1px solid var(--line); border-radius:8px; padding:8px; position:relative; }
    .set .num { font-size:11px; color:var(--muted); margin-bottom:6px; text-align:center; }
    .set .row { display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:center; }
    .num-input { display:flex; align-items:center; background:#0f1320; border:1px solid var(--line); border-radius:8px; overflow:hidden; height:36px; }
    .num-input button { width:36px; height:100%; background:transparent; border:none; color:#cbd5e1; font-size:18px; cursor:pointer; }
    .num-input button:active { background:#0d1220; }
    .num-input .value { flex:1; text-align:center; font-weight:700; letter-spacing:0.2px; cursor:pointer; }
    .num-input .unit { width:44px; text-align:center; font-size:12px; color:#94a3b8; border-left:1px solid var(--line); }
    .set .rm { position:absolute; top:6px; right:6px; background:var(--danger); color:#fff; border:none; width:22px; height:22px; border-radius:50%; font-weight:800; cursor:pointer; }

    .page-actions { display:flex; gap:8px; position:fixed; left:0; right:0; bottom:0; background:var(--card); border-top:1px solid var(--line); padding:8px 12px; z-index:9; }
    .page-actions button { flex:1; }

    @media (max-width:420px){ .stats{ grid-template-columns:1fr 1fr; } }
    datalist option { color:#000; }

    /* Shared list/cards */
    .stat-cards { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin-bottom:12px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; }
    .card h3 { margin:0 0 8px; font-size:14px; color:var(--muted); }
    .metric { font-size:18px; font-weight:700; }
    .list { display:grid; gap:8px; }
    .list-item { background:var(--card2); border:1px solid var(--line); border-radius:8px; padding:8px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .list-item .item-left { display:flex; flex-direction:column; gap:2px; min-width:0; flex:1; cursor:pointer; }
    .list-item .item-left strong { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .icon-btn { background:transparent; border:1px solid var(--line); color:var(--text); width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; }
    .empty { color:var(--muted); text-align:center; padding:16px 8px; }

    /* Stats chart */
    .chart-area { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; margin-top:12px; }
    .chart-header { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .chart-header select { flex:1; background:#0f1320; border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:8px; }
    canvas { width:100%; height:220px; background:#0f1320; border:1px solid var(--line); border-radius:8px; }

    /* Modals (picker + history summary) */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:flex-end; justify-content:center; z-index:20; }
    .modal.show { display:flex; }
    .sheet { width:100%; max-width:520px; background:var(--card); border-top-left-radius:16px; border-top-right-radius:16px; border:1px solid var(--line); padding:12px; }
    .sheet-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:8px; }
    .sheet-title { font-weight:700; }
    .sheet-actions-inline { display:flex; gap:8px; }
    .btn-ok { background:var(--ok); }
    .btn-cancel { background:transparent; border:1px solid var(--line); color:var(--text); }
    .picker { height:200px; overflow-y:auto; scroll-snap-type:y mandatory; background:var(--card2); border:1px solid var(--line); border-radius:12px; padding:6px 0; }
    .pick-item { height:40px; display:flex; align-items:center; justify-content:center; scroll-snap-align:center; color:#cbd5e1; font-weight:600; }
    .pick-item.active { color:#fff; }
    .center-line { position:relative; }
    .center-line::before, .center-line::after {
      content:""; position:absolute; left:10px; right:10px; height:0; border-top:1px dashed #334155;
    }
    .center-line::before { top:80px; }
    .center-line::after  { top:120px; }

    /* History modal content */
    #history-content { background:var(--card2); border:1px solid var(--line); border-radius:12px; padding:10px; max-height:50vh; overflow:auto; }
    #history-content .ex { margin-bottom:10px; }
    #history-content .ex-name { font-weight:700; margin-bottom:4px; }
    #history-content .ex-sets { font-size:13px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>Трекер тренировок</h1>
    <div class="muted">Один день = одна тренировка. Сохранение в Telegram CloudStorage</div>

    <div class="controls" id="controls-workout">
      <label for="date">Дата:</label>
      <input type="date" id="date" />
      <button id="save">Сохранить</button>
      <button id="clear" class="ghost">Очистить день</button>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="workout">Тренировка</button>
      <button class="tab-btn" data-tab="history">История</button>
      <button class="tab-btn" data-tab="stats">Статистика</button>
    </div>
  </header>

  <main>
    <!-- Вкладка: Тренировка -->
    <section id="tab-workout" class="tab active">
      <div class="stats">
        <div class="stat"><h3>Тоннаж</h3><p id="statVolume">0 кг</p></div>
        <div class="stat"><h3>Повторы</h3><p id="statReps">0</p></div>
        <div class="stat"><h3>Макс. вес</h3><p id="statMax">0 кг</p></div>
      </div>

      <div class="hint">Тап по числу — колесо выбора. Кнопки +/- — быстрый шаг. Новый подход копирует вес предыдущего.</div>

      <div id="blocks" class="blocks"></div>
    </section>

    <!-- Вкладка: История -->
    <section id="tab-history" class="tab">
      <div class="card">
        <h3>Прошлые тренировки</h3>
        <div id="history-list" class="list"></div>
      </div>
    </section>

    <!-- Вкладка: Статистика -->
    <section id="tab-stats" class="tab">
      <div class="stat-cards">
        <div class="card">
          <h3>Всего тренировок</h3>
          <div class="metric" id="st-total-workouts">0</div>
        </div>
        <div class="card">
          <h3>Общий тоннаж</h3>
          <div class="metric" id="st-total-volume">0 кг</div>
        </div>
        <div class="card">
          <h3>Средний тоннаж</h3>
          <div class="metric" id="st-avg-volume">0 кг</div>
        </div>
        <div class="card">
          <h3>Лучший день (тоннаж)</h3>
          <div class="metric" id="st-best-volume">0 кг</div>
        </div>
      </div>

      <div class="card">
        <h3>Топ упражнений</h3>
        <div class="list" id="st-top-exercises"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>Рекорды (макс. вес)</h3>
        <div class="list" id="st-records"></div>
      </div>

      <div class="chart-area">
        <div class="chart-header">
          <select id="st-exercise-select"></select>
        </div>
        <canvas id="st-canvas" width="600" height="220"></canvas>
        <div id="st-empty" class="empty" style="display:none;">Нет данных для выбранного упражнения</div>
      </div>
    </section>
  </main>

  <!-- Кнопки добавления -->
  <div class="page-actions" id="page-actions">
    <button id="addSingle" class="ghost">+ Упражнение</button>
    <button id="addSuperset" class="ghost">+ Суперсет</button>
  </div>

  <!-- Модалка: сводка тренировки (История) -->
  <div class="modal" id="history-modal" aria-hidden="true">
    <div class="sheet">
      <div class="sheet-header">
        <div class="sheet-title" id="history-title">Тренировка</div>
        <div class="sheet-actions-inline">
          <button class="btn-cancel" id="history-close">Закрыть</button>
        </div>
      </div>
      <div id="history-content"></div>
    </div>
  </div>

  <!-- Picker Modal -->
  <div class="modal" id="picker-modal" aria-hidden="true">
    <div class="sheet">
      <div class="sheet-header">
        <div class="sheet-title" id="picker-title">Выбор значения</div>
        <div class="sheet-actions-inline">
          <button class="btn-cancel" id="picker-cancel">Отмена</button>
          <button class="btn-ok" id="picker-ok">OK</button>
        </div>
      </div>
      <div class="center-line">
        <div class="picker" id="picker-list"></div>
      </div>
    </div>
  </div>

  <datalist id="exercise-suggestions">
    <!-- Грудь -->
    <option value="Жим лежа штанга"></option>
    <option value="Жим лежа гантели"></option>
    <option value="Жим на наклонной скамье штанга"></option>
    <option value="Жим на наклонной скамье гантели"></option>
    <option value="Разводка гантелей лежа"></option>
    <option value="Сведение рук в тренажере (бабочка)"></option>
    <option value="Отжимания от пола"></option>
    <option value="Отжимания на брусьях (грудь)"></option>
    <!-- Спина -->
    <option value="Подтягивания широким хватом"></option>
    <option value="Подтягивания узким хватом"></option>
    <option value="Тяга верхнего блока"></option>
    <option value="Тяга горизонтального блока"></option>
    <option value="Тяга штанги в наклоне"></option>
    <option value="Тяга гантели в наклоне"></option>
    <option value="Тяга Т-грифа"></option>
    <option value="Пуловер с гантелью"></option>
    <option value="Гиперэкстензия"></option>
    <!-- Ноги -->
    <option value="Приседания со штангой"></option>
    <option value="Фронтальные приседания"></option>
    <option value="Приседания с гантелями"></option>
    <option value="Жим ногами"></option>
    <option value="Выпады с гантелями"></option>
    <option value="Болгарские сплит-приседания"></option>
    <option value="Сгибания ног лежа"></option>
    <option value="Разгибания ног сидя"></option>
    <option value="Подъем на носки стоя (икры)"></option>
    <option value="Подъем на носки сидя (икры)"></option>
    <option value="Румынская тяга со штангой"></option>
    <option value="Румынская тяга с гантелями"></option>
    <!-- Плечи -->
    <option value="Жим гантелей сидя"></option>
    <option value="Жим штанги стоя"></option>
    <option value="Махи гантелями в стороны"></option>
    <option value="Махи гантелями вперед"></option>
    <option value="Тяга штанги к подбородку"></option>
    <option value="Обратные махи (задняя дельта)"></option>
    <option value="Тяга каната к лицу (Face Pull)"></option>
    <!-- Руки -->
    <option value="Подъем штанги на бицепс"></option>
    <option value="Подъем гантелей на бицепс"></option>
    <option value="Молотки с гантелями"></option>
    <option value="Французский жим штанги"></option>
    <option value="Французский жим гантели"></option>
    <option value="Разгибания рук на блоке (трицепс)"></option>
    <option value="Отжимания на брусьях (трицепс)"></option>
    <!-- Пресс -->
    <option value="Скручивания на полу"></option>
    <option value="Скручивания на фитболе"></option>
    <option value="Подъем ног в висе"></option>
    <option value="Планка"></option>
    <option value="Велосипед (пресс)"></option>
    <option value="Русский твист"></option>
  </datalist>

  <template id="set-template">
    <div class="set">
      <div class="num">Подход 1</div>
      <div class="row">
        <div class="num-input" data-type="weight" data-step="2.5">
          <button class="minus" type="button">−</button>
          <div class="value" role="button" aria-label="Вес">0</div>
          <div class="unit">кг</div>
          <button class="plus" type="button">+</button>
        </div>
        <div class="num-input" data-type="reps" data-step="1">
          <button class="minus" type="button">−</button>
          <div class="value" role="button" aria-label="Повторы">0</div>
          <div class="unit">×</div>
          <button class="plus" type="button">+</button>
        </div>
      </div>
      <button class="rm" type="button" title="Удалить подход">×</button>
    </div>
  </template>

  <script>
    // Telegram init
    const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
    if (tg.setHeaderColor) tg.setHeaderColor('#171a21');
    if (tg.setBackgroundColor) tg.setBackgroundColor('#0f1115');

    // Helpers
    const qs = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
    const $date = qs('#date'), $blocks = qs('#blocks'), $pageActions = qs('#page-actions');

    let blockCounter = 0, workoutsCache = [];

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function todayISO(){ const d=new Date(), off=d.getTimezoneOffset()*60000; return new Date(Date.now()-off).toISOString().slice(0,10); }
    function haptic(type='light'){ if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred(type); }

    // Draft helpers
    function saveDraft(){
      const draft = collectWorkoutData();
      // Сохраняем черновик и дату последней активности
      tg.CloudStorage.setItem('draftWorkout', JSON.stringify(draft), ()=>{});
      tg.CloudStorage.setItem('lastWorkoutDate', $date.value, ()=>{});
    }
    function clearDraft(){ tg.CloudStorage.removeItem('draftWorkout', ()=>{}); }
    function loadDraft(cb){
      tg.CloudStorage.getItem('draftWorkout', (err, val)=>{
        if(val){ try { cb(JSON.parse(val)); } catch(e){ cb(null); } }
        else cb(null);
      });
    }

    // Tabs
    qsa('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab, btn)));
    function switchTab(tab, btn){
      qsa('.tab-btn').forEach(b=>b.classList.remove('active')); if (btn) btn.classList.add('active');
      qsa('.tab').forEach(t=>t.classList.remove('active')); qs('#tab-'+tab).classList.add('active');
      const showWorkoutControls = tab==='workout';
      qs('#controls-workout').style.display = showWorkoutControls ? 'flex' : 'none';
      $pageActions.style.display = showWorkoutControls ? 'flex' : 'none';
      if (tab==='stats') renderStatsTab();
      if (tab==='history') renderHistoryTab();
      haptic('light');
    }

    // Workout UI
    function renumberSets(c){ qsa('.set', c).forEach((el,i)=> el.querySelector('.num').textContent = `Подход ${i+1}`); }
    function getNum(el){ return parseFloat(el.textContent) || 0; }
    function setNum(el, val){ el.textContent = String(val); }
    function lastWeightInSets(setsContainer){
      const sets = qsa('.set', setsContainer);
      for (let i = sets.length - 1; i >= 0; i--) {
        const wEl = qs('.num-input[data-type="weight"] .value', sets[i]);
        const w = getNum(wEl);
        if (w > 0) return w;
      }
      return 0;
    }
    function updateStats(){
      let volume=0,reps=0,maxW=0;
      qsa('.set').forEach(s=>{
        const weight = getNum(qs('.num-input[data-type="weight"] .value', s));
        const r = getNum(qs('.num-input[data-type="reps"] .value', s));
        if (weight>0 && r>0) {
          volume += weight * r; reps += r; if (weight > maxW) maxW = weight;
        }
      });
      qs('#statVolume').textContent = `${Math.round(volume)} кг`;
      qs('#statReps').textContent = `${reps}`;
      qs('#statMax').textContent = `${maxW} кг`;
    }

    function createSet(v={}){
      const tpl = qs('#set-template').content.cloneNode(true);
      const s = tpl.querySelector('.set');
      const wEl = qs('.num-input[data-type="weight"] .value', s);
      const rEl = qs('.num-input[data-type="reps"] .value', s);
      setNum(wEl, v.weight != null ? v.weight : 0);
      setNum(rEl, v.reps != null ? v.reps : 0);

      // +/- handlers on this set
      s.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('button');
        if (!btn) return;
        if (btn.classList.contains('rm')) return;
        const wrap = btn.closest('.num-input');
        if (!wrap) return;
        const valEl = qs('.value', wrap);
        const step = parseFloat(wrap.dataset.step) || (wrap.dataset.type==='weight'?2.5:1);
        let val = getNum(valEl);
        if (btn.classList.contains('plus')) val += step;
        if (btn.classList.contains('minus')) val = Math.max(0, val - step);
        if (wrap.dataset.type==='weight') val = Math.round(val*10)/10; else val = Math.round(val);
        setNum(valEl, val);
        updateStats();
        saveDraft();
        haptic('light');
      });

      // open picker
      qsa('.num-input .value', s).forEach(vnode=>{
        vnode.addEventListener('click', ()=> openPicker(vnode));
      });

      // remove set
      qs('.rm', s).addEventListener('click', ()=>{
        const parent = s.parentElement;
        s.remove(); renumberSets(parent); updateStats(); saveDraft(); haptic('medium');
      });

      updateStats();
      return s;
    }

    function subExerciseTemplate(title='Упражнение', suggested=true){
      const sub = document.createElement('div'); sub.className='subex';
      sub.innerHTML = `
        <div class="subex-row">
          <input name="exName" placeholder="${title}" ${suggested?'list="exercise-suggestions"':''} />
          <button class="ghost addSet" type="button">+ подход</button>
        </div>
        <div class="sets"></div>`;
      const sets = qs('.sets', sub);
      // один стартовый подход
      sets.appendChild(createSet({ weight: 0, reps: 0 }));

      const exInput = qs('input[name="exName"]', sub);
      exInput.addEventListener('change', () => {
        exInput.blur(); // закрываем клавиатуру после выбора из списка
        saveDraft();
      });

      renumberSets(sets); updateStats();
      qs('.addSet', sub).addEventListener('click', ()=>{
        const wPrev = lastWeightInSets(sets);
        sets.appendChild(createSet({ weight: wPrev, reps: 0 }));
        renumberSets(sets); updateStats(); saveDraft(); haptic('light');
      });
      return sub;
    }

    function addBlock(type='single'){
      blockCounter+=1; const idx=blockCounter;
      const b=document.createElement('div'); b.className='block'; b.dataset.superset=String(idx);
      b.innerHTML = `
        <div class="block-header">
          <div class="block-title">${type==='superset'?'Суперсет':'Упражнение'} ${idx}</div>
          <div class="block-actions">
            <button class="ghost addSetAll" type="button">+ подход всем</button>
            <button class="danger removeBlock" type="button">Удалить</button>
          </div>
        </div>`;
      if(type==='superset'){ b.appendChild(subExerciseTemplate('Упражнение 1')); b.appendChild(subExerciseTemplate('Упражнение 2')); }
      else { b.appendChild(subExerciseTemplate('Упражнение')); }

      qs('.removeBlock', b).addEventListener('click', ()=>{ b.remove(); renumberBlocks(); updateStats(); saveDraft(); haptic('medium'); });
      qs('.addSetAll', b).addEventListener('click', ()=>{
        qsa('.subex', b).forEach(se=>{
          const sets = qs('.sets', se);
          const wPrev = lastWeightInSets(sets);
          sets.appendChild(createSet({ weight: wPrev, reps: 0 }));
          renumberSets(sets);
        });
        updateStats(); saveDraft(); haptic('light');
      });
      $blocks.appendChild(b); saveDraft(); haptic('light');
    }

    function renumberBlocks(){
      let i=1; qsa('.block').forEach(b=>{ b.dataset.superset=String(i); const t=qs('.block-title',b);
        t.textContent = (t.textContent.startsWith('Суперсет')?'Суперсет ':'Упражнение ') + i; i++; });
    }

    // Data mapping
 function collectWorkoutData(){
  const data = {
    date: $date.value,
    exercises: [],
    totalVolume: 0,
    totalReps: 0,
    userId: tg.initDataUnsafe?.user?.id || 'local'
  };

  qsa('.block').forEach((block, bi) => {
    const sup = bi + 1;
    qsa('.subex', block).forEach(sub => {
      const name = qs('input[name="exName"]', sub).value.trim();
      if (!name) return;

      const sets = [];
      let exVol = 0, exReps = 0, maxW = 0;

      qsa('.set', sub).forEach(s => {
        const w = getNum(qs('.num-input[data-type="weight"] .value', s));
        const r = getNum(qs('.num-input[data-type="reps"] .value', s));
        if (r > 0) { // сохраняем даже если вес = 0
          sets.push({ weight: w, reps: r });
          exVol += w * r;
          exReps += r;
          if (w > maxW) maxW = w;
        }
      });

      if (sets.length || name) {
        data.exercises.push({
          superset: sup,
          name,
          sets,
          volume: Math.round(exVol),
          totalReps: exReps,
          maxWeight: maxW
        });
        data.totalVolume += exVol;
        data.totalReps += exReps;
      }
    });
  });

  data.totalVolume = Math.round(data.totalVolume);
  return data;
}
    
    function populateFromWorkout(w){
      $blocks.innerHTML=''; blockCounter=0;
      const bySup={}; (w.exercises||[]).forEach(ex=>{ (bySup[ex.superset] ||= []).push(ex); });
      const keys=Object.keys(bySup).map(n=>+n).sort((a,b)=>a-b);
      if(!keys.length){ addBlock('superset'); addBlock('single'); updateStats(); return; }
      keys.forEach(k=>{
        const group=bySup[k]; const type = group.length>=2 ? 'superset' : 'single';
        addBlock(type);
        const block = qsa('.block')[qsa('.block').length-1];
        const subs = qsa('.subex', block);
        group.forEach((ex,i)=>{
          const sub = subs[i] || subs[0];
          qs('input[name="exName"]', sub).value = ex.name||'';
          const sets = qs('.sets', sub); sets.innerHTML='';
          (ex.sets||[]).forEach(s=> sets.appendChild(createSet({weight:s.weight, reps:s.reps})));
          renumberSets(sets);
        });
      });
      updateStats();
    }

    // CloudStorage persistent
    function loadFromCloud(cb){
      tg.CloudStorage.getItem('workouts', (err, value)=>{
        if(err){
          try{ const local=localStorage.getItem('workouts'); if(local){ const arr=JSON.parse(local); workoutsCache=arr.slice(); return cb(arr); } }catch(e){}
          workoutsCache=[]; return cb([]);
        }
        if(value){
          try{ const arr=JSON.parse(value)||[]; workoutsCache=arr.slice(); return cb(arr); }catch(e){ workoutsCache=[]; return cb([]); }
        }
        workoutsCache=[]; cb([]);
      });
    }
function saveToCloud(workout, cb) {
  // Приводим дату к формату YYYY-MM-DD
  if (!workout.date) {
    console.error('Нет даты у тренировки, сохранение отменено');
    if (cb) cb();
    return;
  }
  workout.date = workout.date.trim();
  if (!Array.isArray(workout.exercises)) workout.exercises = [];

  tg.CloudStorage.getItem('workouts', (err, value) => {
    let arr = [];
    if (value) {
      try { arr = JSON.parse(value) || []; } catch(e) { arr = []; }
    } else {
      try {
        const local = localStorage.getItem('workouts');
        if (local) arr = JSON.parse(local) || [];
      } catch(e) {}
    }

    const i = arr.findIndex(w => w.date === workout.date);
    if (i >= 0) arr[i] = workout; else arr.push(workout);
    if (arr.length > 300) arr = arr.slice(-300);

    tg.CloudStorage.setItem('workouts', JSON.stringify(arr), (e) => {
      if (e) {
        try { localStorage.setItem('workouts', JSON.stringify(arr)); } catch(_) {}
      }
      workoutsCache = arr.slice();
      tg.CloudStorage.setItem('lastWorkoutDate', workout.date, ()=>{});
      if (cb) cb();
    });
  });
}

function clearDay(dateStr, cb) {
  tg.CloudStorage.getItem('workouts', (err, value) => {
    let arr = [];
    if (value) {
      try { arr = JSON.parse(value) || []; } catch(e) { arr = []; }
    }
    arr = arr.filter(w => w.date !== dateStr);
    tg.CloudStorage.setItem('workouts', JSON.stringify(arr), (e) => {
      if (e) {
        try { localStorage.setItem('workouts', JSON.stringify(arr)); } catch(_) {}
      }
      workoutsCache = arr.slice();
      if (cb) cb();
    });
  });
}

function loadForDate(dateStr) {
  loadFromCloud(list => {
    if (!Array.isArray(list)) list = [];
    const w = list.find(x => x.date === dateStr);
    if (w) {
      if (!Array.isArray(w.exercises)) w.exercises = [];
      populateFromWorkout(w);
    } else {
      $blocks.innerHTML = '';
      blockCounter = 0;
      addBlock('superset');
      addBlock('single');
      updateStats();
    }
  });
}

function renderHistoryTab() {
  loadFromCloud(list => {
    const container = qs('#history-list');
    if (!Array.isArray(list) || !list.length) {
      container.innerHTML = '<div class="empty">Нет сохраненных тренировок</div>';
      return;
    }
    const sorted = list.slice().sort((a,b) => {
      const da = new Date(a.date), db = new Date(b.date);
      return isNaN(db) || isNaN(da) ? 0 : db - da;
    });
    container.innerHTML = sorted.map(w => {
      const dateStr = w.date ? new Date(w.date).toLocaleDateString('ru-RU') : '—';
      const exCount = Array.isArray(w.exercises) ? w.exercises.length : 0;
      const vol = Math.round(w.totalVolume || 0);
      return `
        <div class="list-item" data-date="${escapeHtml(w.date || '')}">
          <div class="item-left" data-action="summary" title="Открыть сводку">
            <strong>${dateStr}</strong>
            <small class="muted">Тоннаж: ${vol} кг • Упр.: ${exCount}</small>
          </div>
          <button class="icon-btn" data-action="edit" title="Редактировать" aria-label="Редактировать">✏️</button>
        </div>
      `;
    }).join('');
  });
}

function renderStatsTab() {
  loadFromCloud(list => {
    if (!Array.isArray(list)) list = [];

    const workouts = list.slice().sort((a,b) => {
      const da = new Date(a.date), db = new Date(b.date);
      return isNaN(da) || isNaN(db) ? 0 : da - db;
    });

    const total = workouts.length;
    const totalVol = workouts.reduce((s,w) => s + (w.totalVolume || 0), 0);
    const avgVol = total ? Math.round(totalVol / total) : 0;
    const bestVol = workouts.reduce((m,w) => Math.max(m, w.totalVolume || 0), 0);

    qs('#st-total-workouts').textContent = total;
    qs('#st-total-volume').textContent = `${Math.round(totalVol)} кг`;
    qs('#st-avg-volume').textContent = `${avgVol} кг`;
    qs('#st-best-volume').textContent = `${Math.round(bestVol)} кг`;

    const exCount = {}, records = {};
    workouts.forEach(w => (Array.isArray(w.exercises) ? w.exercises : []).forEach(ex => {
      exCount[ex.name] = (exCount[ex.name] || 0) + 1;
      records[ex.name] = Math.max(records[ex.name] || 0, ex.maxWeight || 0);
    }));

    const top = Object.entries(exCount).sort((a,b) => b[1] - a[1]).slice(0,10);
    qs('#st-top-exercises').innerHTML = top.length
      ? top.map(([n,c]) => `<div class="list-item"><span>${escapeHtml(n)}</span><span>${c} раз</span></div>`).join('')
      : '<div class="empty">Пока нет данных</div>';

    const recs = Object.entries(records).sort((a,b) => b[1] - a[1]);
    qs('#st-records').innerHTML = recs.length
      ? recs.map(([n,w]) => `<div class="list-item"><span>${escapeHtml(n)}</span><span>🏆 ${w} кг</span></div>`).join('')
      : '<div class="empty">Пока нет данных</div>';

    const names = Array.from(new Set(workouts.flatMap(w =>
      Array.isArray(w.exercises) ? w.exercises.map(ex => ex.name) : []
    ))).sort();

    const sel = qs('#st-exercise-select');
    const prev = sel.value;
    sel.innerHTML = names.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
    sel.value = (prev && names.includes(prev)) ? prev : (names[0] || '');
    drawProgressChart();
  });
}
function drawProgressChart() {
  const sel = qs('#st-exercise-select'), name = sel?.value;
  const canvas = qs('#st-canvas'), empty = qs('#st-empty');
  const cssW = canvas.clientWidth || 600, cssH = canvas.clientHeight || 220;
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.round(cssW * dpr);
  canvas.height = Math.round(cssH * dpr);
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, cssW, cssH);

  if (!name) {
    empty.style.display = 'block';
    empty.textContent = 'Выберите упражнение';
    return;
  }
  empty.style.display = 'none';

  const workouts = (Array.isArray(workoutsCache) ? workoutsCache : [])
    .filter(w => w.date && !isNaN(new Date(w.date)))
    .sort((a, b) => new Date(a.date) - new Date(b.date));

  const pts = [];
  workouts.forEach(w => {
    const ex = Array.isArray(w.exercises) ? w.exercises.find(e => e.name === name) : null;
    if (ex) {
      // Берём максимум из подходов, если они есть
      let dayMax = 0;
      if (Array.isArray(ex.sets) && ex.sets.length) {
        dayMax = Math.max(...ex.sets.map(s => s.weight || 0), 0);
      }
      // Если подходов нет, используем maxWeight
      if (!dayMax && ex.maxWeight) dayMax = ex.maxWeight;
      pts.push({ date: new Date(w.date), value: dayMax });
    }
  });

  if (!pts.length) {
    empty.style.display = 'block';
    empty.textContent = 'Нет данных для выбранного упражнения';
    return;
  }

  const padL = 40, padR = 10, padT = 10, padB = 30, W = cssW, H = cssH, PW = W - padL - padR, PH = H - padT - padB;
  const minV = 0, maxV = Math.max(...pts.map(p => p.value)), rangeV = Math.max(1, maxV - minV);
  const minT = pts[0].date.getTime(), maxT = pts[pts.length - 1].date.getTime(), rangeT = Math.max(1, maxT - minT);

  // Оси
  ctx.strokeStyle = '#aaa'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL, H - padB); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(padL, H - padB); ctx.lineTo(W - padR, H - padB); ctx.stroke();

  // Горизонтальные линии и подписи
  ctx.font = '12px sans-serif'; ctx.fillStyle = '#666'; ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
  const ticks = 4;
  for (let i = 0; i <= ticks; i++) {
    const v = minV + rangeV * i / ticks;
    const y = padT + PH - (PH * (v - minV) / rangeV);
    ctx.strokeStyle = '#2a2f3a';
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W - padR, y); ctx.stroke();
    ctx.fillText(String(Math.round(v)), padL - 6, y);
  }

  // Даты
  ctx.textAlign = 'center'; ctx.textBaseline = 'top'; ctx.fillStyle = '#666';
  ctx.fillText(new Date(minT).toLocaleDateString('ru-RU'), padL, H - padB + 6);
  ctx.fillText(new Date(maxT).toLocaleDateString('ru-RU'), W - padR, H - padB + 6);

  // Линия
  ctx.strokeStyle = '#4f8cff'; ctx.lineWidth = 2; ctx.beginPath();
  pts.forEach((p, i) => {
    const x = padL + PW * ((p.date.getTime() - minT) / rangeT);
    const y = padT + PH - (PH * (p.value - minV) / rangeV);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Точки
  ctx.fillStyle = '#9aa4b2';
  pts.forEach(p => {
    const x = padL + PW * ((p.date.getTime() - minT) / rangeT);
    const y = padT + PH - (PH * (p.value - minV) / rangeV);
    ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2); ctx.fill();
  });
}

    // Picker logic
    const pickerModal = qs('#picker-modal');
    const pickerList = qs('#picker-list');
    const pickerTitle = qs('#picker-title');
    const pickerOk = qs('#picker-ok');
    const pickerCancel = qs('#picker-cancel');
    let pickerTarget = null;
    const ITEM_H = 40;
    const CENTER_OFFSET = 80;

    function openPicker(valueEl){
      pickerTarget = valueEl;
      const wrap = valueEl.closest('.num-input');
      const type = wrap.dataset.type;
      const step = parseFloat(wrap.dataset.step) || (type==='weight'?2.5:1);
      const max = type==='weight' ? 300 : 50;
      const title = type==='weight' ? 'Выбор веса (кг)' : 'Выбор повторов';
      pickerTitle.textContent = title;

      pickerList.innerHTML = '';
      const values=[];
      for(let v=0; v<=max+1e-9; v+=step) values.push(type==='weight'? Math.round(v*10)/10 : Math.round(v));
      values.forEach(v=>{
        const item=document.createElement('div');
        item.className='pick-item';
        item.textContent = String(v);
        pickerList.appendChild(item);
      });

      const cur = parseFloat(valueEl.textContent)||0;
      let idx = Math.round(cur / step);
      if (idx < 0) idx = 0;
      if (idx > values.length - 1) idx = values.length - 1;
      activatePickerIndex(idx);
      setTimeout(()=>{ pickerList.scrollTo({ top: Math.max(0, idx*ITEM_H - CENTER_OFFSET), behavior:'instant' }); }, 0);

      pickerModal.classList.add('show');
      pickerModal.setAttribute('aria-hidden', 'false');
      haptic('light');
    }

    function activatePickerIndex(i){
      qsa('.pick-item', pickerList).forEach((el,ix)=> el.classList.toggle('active', ix===i));
    }

    pickerList.addEventListener('scroll', ()=>{
      const i = Math.round((pickerList.scrollTop + 80) / ITEM_H);
      activatePickerIndex(Math.max(0, i));
    }, { passive:true });

    pickerOk.addEventListener('click', ()=>{
      const active = qs('.pick-item.active', pickerList);
      if (pickerTarget && active) {
        pickerTarget.textContent = active.textContent;
        updateStats();
        saveDraft();
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
      }
      closePicker();
    });

    pickerCancel.addEventListener('click', closePicker);
    pickerModal.addEventListener('click', (e)=>{ if (e.target === pickerModal) closePicker(); });

    function closePicker(){
      pickerModal.classList.remove('show');
      pickerModal.setAttribute('aria-hidden', 'true');
      pickerTarget = null;
    }

    // History tab
 function renderHistoryTab() {
  loadFromCloud(list => {
    const container = qs('#history-list');
    if (!Array.isArray(list) || !list.length) {
      container.innerHTML = '<div class="empty">Нет сохраненных тренировок</div>';
      return;
    }
    const sorted = list.slice().sort((a, b) => {
      const da = new Date(a.date), db = new Date(b.date);
      return isNaN(db) || isNaN(da) ? 0 : db - da;
    });
    container.innerHTML = sorted.map(w => {
      const dateStr = w.date ? new Date(w.date).toLocaleDateString('ru-RU') : '—';
      const exCount = Array.isArray(w.exercises) ? w.exercises.length : 0;
      const vol = Math.round(w.totalVolume || 0);
      return `
        <div class="list-item" data-date="${escapeHtml(w.date || '')}">
          <div class="item-left" data-action="summary" title="Открыть сводку">
            <strong>${dateStr}</strong>
            <small class="muted">Тоннаж: ${vol} кг • Упр.: ${exCount}</small>
          </div>
          <button class="icon-btn" data-action="edit" title="Редактировать" aria-label="Редактировать">✏️</button>
        </div>
      `;
    }).join('');
  });
}

    function openHistorySummary(date){
      const w = workoutsCache.find(x=>x.date===date);
      if(!w) return;
      qs('#history-title').textContent = new Date(w.date).toLocaleDateString('ru-RU');
      let html = `<p>Тоннаж: ${w.totalVolume} кг<br>Повторы: ${w.totalReps}</p>`;
      (w.exercises||[]).forEach(ex=>{
        html += `<div class="ex">
          <div class="ex-name">${escapeHtml(ex.name)}</div>
          <div class="ex-sets">${(ex.sets||[]).map(s=>`${s.weight}×${s.reps}`).join(', ')}</div>
        </div>`;
      });
      qs('#history-content').innerHTML = html;
      qs('#history-modal').classList.add('show');
      qs('#history-modal').setAttribute('aria-hidden','false');
    }

    function editWorkout(date){
      const w = workoutsCache.find(x=>x.date===date);
      if(!w) return;
      $date.value = w.date;
      populateFromWorkout(w);
      switchTab('workout', qs('.tab-btn[data-tab="workout"]'));
    }

    // Delegated clicks for history
    document.addEventListener('click', e=>{
      const list = qs('#history-list');
      if (!list || !list.contains(e.target)) return;
      const item = e.target.closest('.list-item');
      if(!item) return;
      const date = item.dataset.date;
      if(e.target.dataset.action==='edit' || e.target.closest('[data-action="edit"]')){
        editWorkout(date);
      } else if(e.target.dataset.action==='summary' || e.target.closest('[data-action="summary"]')){
        openHistorySummary(date);
      }
    });
    qs('#history-close').addEventListener('click', ()=>{
      const m = qs('#history-modal');
      m.classList.remove('show'); m.setAttribute('aria-hidden','true');
    });

    // Events
    qs('#addSingle').addEventListener('click', ()=>{ addBlock('single'); saveDraft(); });
    qs('#addSuperset').addEventListener('click', ()=>{ addBlock('superset'); saveDraft(); });

    qs('#save').addEventListener('click', ()=>{
      if(!$date.value) return tg.showAlert('Выбери дату');
      const data=collectWorkoutData();
      if(!data.exercises.length) return tg.showAlert('Добавь хотя бы одно упражнение с подходами');
      saveToCloud(data, ()=>{
        clearDraft();
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        tg.showPopup({ title:'Сохранено', message:`📅 ${new Date(data.date).toLocaleDateString('ru-RU')}\n⚖️ ${data.totalVolume} кг • 🔄 ${data.totalReps} повт.`, buttons:[{type:'ok'}] });
        if (qs('#tab-history').classList.contains('active')) renderHistoryTab();
        if (qs('#tab-stats').classList.contains('active')) renderStatsTab();
      });
    });

    qs('#clear').addEventListener('click', ()=>{
      if(!$date.value) return tg.showAlert('Выбери дату');
      tg.showConfirm(`Очистить тренировку за ${new Date($date.value).toLocaleDateString('ru-RU')}?`, ok=>{
        if(!ok) return;
        clearDay($date.value, ()=>{
          clearDraft();
          $blocks.innerHTML=''; blockCounter=0; addBlock('superset'); addBlock('single'); updateStats(); tg.showAlert('День очищен');
          if (qs('#tab-history').classList.contains('active')) renderHistoryTab();
          if (qs('#tab-stats').classList.contains('active')) renderStatsTab();
        });
      });
    });

    $date.addEventListener('change', e=>{ loadForDate(e.target.value); saveDraft(); });
    qs('#st-exercise-select').addEventListener('change', drawProgressChart);

    // Init with draft-first logic (Variant 1)
    function initLoad(){
      loadDraft(draft=>{
        if(draft){
          if(draft.date === todayISO()){
            $date.value = draft.date;
            populateFromWorkout(draft);
          } else {
            tg.showConfirm(`У тебя есть незавершенная тренировка от ${new Date(draft.date).toLocaleDateString('ru-RU')}. Продолжить ее?`, ok=>{
              if(ok){
                $date.value = draft.date;
                populateFromWorkout(draft);
              } else {
                clearDraft();
                $date.value = todayISO();
                loadForDate($date.value);
              }
            });
          }
        } else {
          tg.CloudStorage.getItem('lastWorkoutDate', (err, lastDate) => {
            if (lastDate) {
              if (lastDate === todayISO()) {
                $date.value = lastDate;
                loadForDate(lastDate);
              } else {
                tg.showConfirm(`Продолжить тренировку от ${new Date(lastDate).toLocaleDateString('ru-RU')}?`, ok => {
                  if (ok) {
                    $date.value = lastDate;
                    loadForDate(lastDate);
                  } else {
                    $date.value = todayISO();
                    loadForDate($date.value);
                  }
                });
              }
            } else {
              $date.value = todayISO();
              loadForDate($date.value);
            }
          });
        }
      });
    }

    // Start
    initLoad();
  </script>
</body>
</html>
