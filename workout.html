<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Workout Tracker - Telegram App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
      padding-bottom: 60px;
      overflow-x: hidden;
    }

    .header {
      background: var(--tg-theme-header-bg-color, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
      color: white;
      padding: 15px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .header-back {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
    }

    .date-selector {
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      padding: 10px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
    }

    .date-selector input {
      background: var(--tg-theme-bg-color, white);
      border: 1px solid var(--tg-theme-hint-color, #ccc);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 16px;
      color: var(--tg-theme-text-color, #000);
    }

    .quick-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 15px;
      background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    }

    .stat-mini {
      background: var(--tg-theme-bg-color, white);
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stat-mini-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--tg-theme-link-color, #667eea);
    }

    .stat-mini-label {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #999);
      margin-top: 4px;
    }

    .container {
      padding: 15px;
    }

    .superset {
      background: var(--tg-theme-bg-color, white);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    }

    .superset-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    }

    .superset-title {
      font-weight: 600;
      color: var(--tg-theme-link-color, #667eea);
      font-size: 16px;
    }

    .exercise-block {
      margin-bottom: 15px;
    }

    .exercise-select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 6px;
      background: var(--tg-theme-bg-color, white);
      color: var(--tg-theme-text-color, #000);
    }

    .record-hint {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #888);
      margin-bottom: 8px;
    }

    .sets-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }

    .set-block {
      background: var(--tg-theme-secondary-bg-color, #f8f9fa);
      border-radius: 8px;
      padding: 8px 28px 8px 8px;
      border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      position: relative;
    }

    .set-remove-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      background: #ff4d4f;
      color: #fff;
      font-weight: 700;
      line-height: 20px;
      text-align: center;
      cursor: pointer;
      opacity: 0.9;
    }
    .set-remove-btn:active { transform: scale(0.96); opacity: 1; }

    .set-number {
      font-size: 11px;
      color: var(--tg-theme-hint-color, #999);
      margin-bottom: 4px;
      text-align: center;
    }

    .set-inputs {
      display: flex;
      gap: 4px;
    }

    /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
       –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ø–æ–ª—è –≤–≤–æ–¥–∞
    ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
    .set-inputs input {
      width: 3.5em;
      font-size: 1.1em;
      padding: 4px;
      text-align: center;
      border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      border-radius: 6px;
      background: var(--tg-theme-bg-color, white);
      color: var(--tg-theme-text-color, #000);
    }

    .set-inputs input:focus {
      outline: none;
      border-color: var(--tg-theme-link-color, #667eea);
    }

    /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
       –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ —Ç–æ–Ω–Ω–∞–∂–∞/–ø–æ–≤—Ç–æ—Ä–æ–≤
    ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
    .exercise-summary {
      display: flex;
      justify-content: center;
      gap: 8px;
      font-size: 0.9em;
      color: var(--tg-theme-hint-color, #555);
      margin-top: 6px;
    }

    .btn {
      width: 100%;
      padding: 12px;
      background: var(--tg-theme-button-color, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
      color: var(--tg-theme-button-text-color, white);
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-add {
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-link-color, #667eea);
      border: 2px dashed var(--tg-theme-link-color, #667eea);
      margin-bottom: 15px;
    }

    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--tg-theme-bg-color, white);
      border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      padding: 8px 10px;
      display: flex;
      gap: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .bottom-bar::-webkit-scrollbar { height: 6px; }
    .bottom-bar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }

    .tab-btn {
      flex: 1 0 20%;
      min-width: 72px;
      padding: 6px;
      background: transparent;
      border: none;
      color: var(--tg-theme-hint-color, #999);
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
    }

    .tab-btn.active {
      color: var(--tg-theme-link-color, #667eea);
    }

    .tab-btn-icon {
      font-size: 18px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .history-item {
      background: var(--tg-theme-bg-color, white);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    }

    .history-date {
      font-weight: 600;
      color: var(--tg-theme-text-color, #000);
      margin-bottom: 8px;
    }

    .history-stats {
      display: flex;
      justify-content: space-between;
      color: var(--tg-theme-hint-color, #666);
      font-size: 14px;
    }

    .exercise-item {
      background: var(--tg-theme-secondary-bg-color, #f8f9fa);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--tg-theme-hint-color, #999);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--tg-theme-hint-color, #999);
    }

    .section-title {
      margin: 20px 0 10px;
      color: var(--tg-theme-text-color, #000);
    }

    canvas {
      width: 100%;
      height: 200px;
      background: var(--tg-theme-bg-color, #fff);
      border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      border-radius: 8px;
    }

    @media (max-width: 360px) {
      .sets-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    </style>
</head>
<body>
    <div class="header" style="position: sticky; top: 0;">
      <button class="header-back" onclick="goBack()" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
      <h1>üí™ Workout Tracker</h1>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
    <div id="workout-tab" class="tab-content active">
      <div class="date-selector">
        <label for="workout-date">–î–∞—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:</label>
        <input type="date" id="workout-date">
      </div>

      <div class="quick-stats">
        <div class="stat-mini">
          <div class="stat-mini-value" id="current-volume">0</div>
          <div class="stat-mini-label">–¢–æ–Ω–Ω–∞–∂ (–∫–≥)</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-value" id="current-reps">0</div>
          <div class="stat-mini-label">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</div>
        </div>
      </div>

      <div class="container" id="supersets-container">
        <!-- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏ —Å—É–øe—Ä—Å–µ—Ç–æ–≤/—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
      </div>

      <div class="container">
        <button id="add-btn" class="btn btn-add" onclick="addItem()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—É–ø–µ—Ä—Å–µ—Ç</button>
        <button class="btn" onclick="saveWorkout()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
    <div id="history-tab" class="tab-content">
      <div class="container" id="history-container">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div id="stats-tab" class="tab-content">
      <div class="container">
        <div class="quick-stats">
          <div class="stat-mini">
            <div class="stat-mini-value" id="total-workouts">0</div>
            <div class="stat-mini-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini-value" id="total-volume">0</div>
            <div class="stat-mini-label">–û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂</div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini-value" id="avg-volume">0</div>
            <div class="stat-mini-label">–°—Ä–µ–¥–Ω–∏–π —Ç–æ–Ω–Ω–∞–∂</div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini-value" id="total-exercises">0</div>
            <div class="stat-mini-label">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>
          </div>
        </div>

        <h3 class="section-title">–¢–æ–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:</h3>
        <div id="top-exercises"></div>

        <h3 class="section-title">–†–µ–∫–æ—Ä–¥—ã (–º–∞–∫—Å. –≤–µ—Å):</h3>
        <div id="records-list"></div>

        <h3 class="section-title">–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:</h3>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
          <select id="progress-exercise-select" class="exercise-select" style="flex:1;" onchange="updateProgressChart()">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>
          </select>
        </div>
        <canvas id="progress-canvas" width="600" height="220"></canvas>
        <div id="progress-empty" class="empty-state" style="display:none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>
        <div id="progress-1rm" class="record-hint" style="text-align:center; margin-top:8px;"></div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
    <div id="exercises-tab" class="tab-content">
      <div class="container">
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <input type="text" id="new-exercise" placeholder="–ù–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" style="flex: 1; padding: 10px; border: 1px solid var(--tg-theme-hint-color, #ccc); border-radius: 8px;">
          <button class="btn btn-small" onclick="addExercise()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div id="exercises-list"></div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settings-tab" class="tab-content">
      <div class="container">
        <h3 class="section-title">–†–µ–∂–∏–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
        <select id="mode-select" class="exercise-select" onchange="changeMode(this.value)">
          <option value="superset">–°—É–ø–µ—Ä—Å–µ—Ç–∞–º–∏</option>
          <option value="single">–û–¥–∏–Ω–æ—á–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</option>
        </select>
        <div style="font-size:13px; color:var(--tg-theme-hint-color, #777); margin-top:6px;">
          –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∫–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑—É –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ ‚Äú–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ‚Äù, –∏ –∫–∞–∂–¥—ã–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ.
        </div>
      </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <div class="bottom-bar">
      <button class="tab-btn active" onclick="showTab(this, 'workout')">
        <span class="tab-btn-icon">üèãÔ∏è</span>
        <span>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span>
      </button>
      <button class="tab-btn" onclick="showTab(this, 'history')">
        <span class="tab-btn-icon">üìã</span>
        <span>–ò—Å—Ç–æ—Ä–∏—è</span>
      </button>
      <button class="tab-btn" onclick="showTab(this, 'stats')">
        <span class="tab-btn-icon">üìä</span>
        <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
      </button>
      <button class="tab-btn" onclick="showTab(this, 'exercises')">
        <span class="tab-btn-icon">üí™</span>
        <span>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</span>
      </button>
      <button class="tab-btn" onclick="showTab(this, 'settings')">
        <span class="tab-btn-icon">‚öôÔ∏è</span>
        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </button>
    </div>

    <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã
    tg.setHeaderColor('secondary_bg_color');
    tg.setBackgroundColor('bg_color');

    // –ë–∞–∑–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
    let exercises = [
      '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è —à–∏—Ä–æ–∫–∏–º —Ö–≤–∞—Ç–æ–º',
      '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è —É–∑–∫–∏–º —Ö–≤–∞—Ç–æ–º',
      '–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö',
      '–ñ–∏–º –ª–µ–∂–∞ —à—Ç–∞–Ω–≥–∞',
      '–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª–µ–∂–∞',
      '–†–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥',
      '–°–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥',
      '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å–æ —à—Ç–∞–Ω–≥–æ–π',
      '–ñ–∏–º –Ω–æ–≥–∞–º–∏',
      '–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞',
      '–¢—è–≥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞',
      '–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è',
      '–ú–∞—Ö–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—ã',
      '–ü–æ–¥—ä–µ–º —à—Ç–∞–Ω–≥–∏ –Ω–∞ –±–∏—Ü–µ–ø—Å',
      '–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º',
      '–°–≤–µ–¥–µ–Ω–∏–µ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ',
      '–†–∞–∑–≤–æ–¥–∫–∞ –≥–∞–Ω—Ç–µ–ª–µ–π',
      '–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è',
      '–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è',
      '–ü–ª–∞–Ω–∫–∞'
    ];

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ä–µ–∫–æ—Ä–¥—ã
    let settings = { mode: 'superset' };
    let records = {};
    let currentSupersetCount = 0;

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // –ü–µ—Ä–µ—Å—á—ë—Ç —Ç–æ–Ω–Ω–∞–∂–∞ –∏ –ø–æ–≤—Ço—Ä–æ–≤ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ .exercise-block
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function updateExerciseStats(exBlock) {
      let tonnage = 0, reps = 0;
      exBlock.querySelectorAll('.set-block').forEach(set => {
        const inputs = set.querySelectorAll('.set-inputs input');
        const w = parseFloat(inputs[0].value) || 0;
        const r = parseInt(inputs[1].value, 10) || 0;
        tonnage += w * r;
        reps    += r;
      });
      exBlock.querySelector('.exercise-tonnage').textContent = `–¢–æ–Ω–Ω–∞–∂: ${tonnage} –∫–≥`;
      exBlock.querySelector('.exercise-reps').textContent    = `–ü–æ–≤—Ç–æ—Ä–æ–≤: ${reps}`;
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // –ü–µ—Ä–µ–Ω—É–º–µ—Ä–æ–≤—ã–≤–∞–µ–º —Å—É–ø–µ—Ä–∫–µ—Ç—ã/—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ –ø–æ—Ä—è–¥–∫—É
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function renumberSupersets() {
      document.querySelectorAll('.superset').forEach((sup, i) => {
        const titleEl = sup.querySelector('.superset-title');
        if (!titleEl) return;
        titleEl.textContent = settings.mode === 'single'
          ? `–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ${i + 1}`
          : `–°—É–ø–µ—Ä—Å–µ—Ç ${i + 1}`;
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('workout-date').value = new Date().toISOString().split('T')[0];

      loadAll(() => {
        buildInitialItems();
        updateExercisesList();
        updateStats();
        populateProgressExerciseSelect();
        updateModeUI();
        refreshRecordHints();
        resizeCanvasToDevicePixelRatio(document.getElementById('progress-canvas'));
      });
    });

    function showTab(btn, tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');

      if (tabName === 'history') updateHistory();
      else if (tabName === 'stats') {
        updateStats();
        updateProgressChart();
      }

      if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function buildInitialItems() {
      document.getElementById('supersets-container').innerHTML = '';
      currentSupersetCount = 0;
      if (settings.mode === 'superset') {
        addSuperset(); addSuperset(); addSuperset();
      } else {
        addSingleExercise(); addSingleExercise(); addSingleExercise();
      }
      updateCurrentStats();
      renumberSupersets();
    }

    function updateModeUI() {
      const addBtn = document.getElementById('add-btn');
      addBtn.textContent = settings.mode === 'single' ? '‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ' : '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—É–ø–µ—Ä—Å–µ—Ç';
      document.getElementById('mode-select').value = settings.mode;
    }

    function addItem() {
      settings.mode === 'single' ? addSingleExercise() : addSuperset();
    }

    function optionsHtml(arr) {
      return arr.map(ex => `<option value="${escapeHtml(ex)}">${escapeHtml(ex)}</option>`).join('');
    }

    function addSuperset() {
      currentSupersetCount++;
      const container = document.getElementById('supersets-container');
      const supersetDiv = document.createElement('div');
      supersetDiv.className = 'superset';
      supersetDiv.id = `superset-${currentSupersetCount}`;
      supersetDiv.innerHTML = `
        <div class="superset-header">
          <span class="superset-title">–°—É–ø–µ—Ä—Å–µ—Ç ${currentSupersetCount}</span>
          <button class="btn btn-small btn-danger" onclick="removeSuperset(${currentSupersetCount})">‚úï</button>
        </div>

        <div class="exercise-block">
          <select class="exercise-select" onchange="updateCurrentStats(); refreshRecordHints();">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 1</option>
            ${optionsHtml(exercises)}
          </select>
          <div class="record-hint"></div>
          <div class="sets-container" id="sets-${currentSupersetCount}-1">
            ${createSetBlocks(4)}
          </div>
          <button class="btn btn-small" style="margin-top:8px;" onclick="addSet(${currentSupersetCount},1)">+ –ü–æ–¥—Ö–æ–¥</button>
          <div class="exercise-summary">
            <span class="exercise-tonnage">–¢–æ–Ω–Ω–∞–∂: 0 –∫–≥</span> |
            <span class="exercise-reps">–ü–æ–≤—Ç–æ—Ä–æ–≤: 0</span>
          </div>
        </div>

        <div class="exercise-block">
          <select class="exercise-select" onchange="updateCurrentStats(); refreshRecordHints();">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 2</option>
            ${optionsHtml(exercises)}
          </select>
          <div class="record-hint"></div>
          <div class="sets-container" id="sets-${currentSupersetCount}-2">
            ${createSetBlocks(4)}
          </div>
          <button class="btn btn-small" style="margin-top:8px;" onclick="addSet(${currentSupersetCount},2)">+ –ü–æ–¥—Ö–æ–¥</button>
          <div class="exercise-summary">
            <span class="exercise-tonnage">–¢–æ–Ω–Ω–∞–∂: 0 –∫–≥</span> |
            <span class="exercise-reps">–ü–æ–≤—Ç–æ—Ä–æ–≤: 0</span>
          </div>
        </div>
      `;
      container.appendChild(supersetDiv);
      if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      refreshRecordHints();
      renumberSupersets();
    }

    function addSingleExercise() {
      currentSupersetCount++;
      const container = document.getElementById('supersets-container');
      const blockDiv = document.createElement('div');
      blockDiv.className = 'superset';
      blockDiv.id = `superset-${currentSupersetCount}`;
      blockDiv.innerHTML = `
        <div class="superset-header">
          <span class="superset-title">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ${currentSupersetCount}</span>
          <button class="btn btn-small btn-danger" onclick="removeSuperset(${currentSupersetCount})">‚úï</button>
        </div>

        <div class="exercise-block">
          <select class="exercise-select" onchange="updateCurrentStats(); refreshRecordHints();">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>
            ${optionsHtml(exercises)}
          </select>
          <div class="record-hint"></div>
          <div class="sets-container" id="sets-${currentSupersetCount}-1">
            ${createSetBlocks(4)}
          </div>
          <button class="btn btn-small" style="margin-top:8px;" onclick="addSet(${currentSupersetCount},1)">+ –ü–æ–¥—Ö–æ–¥</button>
          <div class="exercise-summary">
            <span class="exercise-tonnage">–¢–æ–Ω–Ω–∞–∂: 0 –∫–≥</span> |
            <span class="exercise-reps">–ü–æ–≤—Ç–æ—Ä–æ–≤: 0</span>
          </div>
        </div>
      `;
      container.appendChild(blockDiv);
      if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      refreshRecordHints();
      renumberSupersets();
    }

    function createSetBlocks(count) {
      let html = '';
      for (let i = 1; i <= count; i++) {
        html += `
        <div class="set-block">
          <div class="set-number">–ü–æ–¥—Ö–æ–¥ ${i}</div>
          <div class="set-inputs">
            <input type="number" placeholder="–∫–≥" class="weight-input" onchange="updateCurrentStats(); updateExerciseStats(this.closest('.exercise-block'))">
            <input type="number" placeholder="√ó" class="reps-input" onchange="updateCurrentStats(); updateExerciseStats(this.closest('.exercise-block'))">
          </div>
          <button class="set-remove-btn" onclick="removeSet(this)" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥">√ó</button>
        </div>`;
      }
      return html;
    }

    function addSet(supersetId, exerciseNum) {
      const container = document.getElementById(`sets-${supersetId}-${exerciseNum}`);
      const setCount = container.querySelectorAll('.set-block').length + 1;
      const setBlock = document.createElement('div');
      setBlock.className = 'set-block';
      setBlock.innerHTML = `
        <div class="set-number">–ü–æ–¥—Ö–æ–¥ ${setCount}</div>
        <div class="set-inputs">
          <input type="number" placeholder="–∫–≥" class="weight-input" onchange="updateCurrentStats(); updateExerciseStats(this.closest('.exercise-block'))">
          <input type="number" placeholder="√ó" class="reps-input" onchange="updateCurrentStats(); updateExerciseStats(this.closest('.exercise-block'))">
        </div>
        <button class="set-remove-btn" onclick="removeSet(this)" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥">√ó</button>
      `;
      container.appendChild(setBlock);
      if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      updateExerciseStats(container.closest('.exercise-block'));
    }

    function removeSet(btn) {
      const setBlock = btn.closest('.set-block');
      if (!setBlock) return;
      const setsContainer = setBlock.parentElement;
      setBlock.remove();
      // –ø–µ—Ä–µ–Ω—É–º–µ—Ä—É–µ–º –ø–æ–¥—Ö–æ–¥—ã
      setsContainer.querySelectorAll('.set-block .set-number').forEach((el, idx) => {
        el.textContent = `–ü–æ–¥—Ö–æ–¥ ${idx + 1}`;
      });
      updateCurrentStats();
      updateExerciseStats(setsContainer.closest('.exercise-block'));
      if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function removeSuperset(id) {
      const superset = document.getElementById(`superset-${id}`);
      if (superset) {
        superset.remove();
        updateCurrentStats();
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        renumberSupersets();
      }
    }

    function updateCurrentStats() {
      let totalVolume = 0;
      let totalReps = 0;
      document.querySelectorAll('.superset').forEach(superset => {
        superset.querySelectorAll('.exercise-block').forEach(block => {
          const exerciseName = block.querySelector('.exercise-select').value;
          if (!exerciseName) return;
          block.querySelectorAll('.set-block').forEach(setBlock => {
            const weight = parseFloat(setBlock.querySelector('.weight-input').value) || 0;
            const reps = parseInt(setBlock.querySelector('.reps-input').value) || 0;
            if (weight > 0 && reps > 0) {
              totalVolume += weight * reps;
              totalReps += reps;
            }
          });
          updateExerciseStats(block);
        });
      });
      document.getElementById('current-volume').textContent = Math.round(totalVolume);
      document.getElementById('current-reps').textContent = totalReps;
    }

    // –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
    // —Ñ—É–Ω–∫—Ü–∏–∏ saveWorkout, updateHistory, viewWorkout, updateStats, populateProgressExerciseSelect,
    // refreshRecordHints, updateProgressChart, resizeCanvasToDevicePixelRatio,
    // saveToCloud, loadFromCloud, saveRecords, loadRecords,
    // changeMode, saveSettings, loadSettings, saveExercises, loadData, loadAll, goBack –∏ —Ç.–¥.

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π input-—Å–ª—É—à–∞—Ç–µ–ª—å
    document.addEventListener('input', e => {
      if (!e.target.classList.contains('weight-input') && !e.target.classList.contains('reps-input'))
        return;
      const ex = e.target.closest('.exercise-block');
      if (ex) updateExerciseStats(ex);
    });
    </script>
</body>
</html>
