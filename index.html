
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fitness Hub - Simple Dropdowns</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components.css">
</head>
<body>
    <div id="app">
        <!-- Main Navigation -->
        <header class="app-header">
            <h1 class="app-title">üèãÔ∏è Fitness Hub</h1>
            <button id="settings-btn" class="icon-btn">‚öôÔ∏è</button>
        </header>

        <!-- Module Cards -->
        <div id="main-screen" class="screen active">
            <div class="modules-grid">
                <div class="module-card active" data-module="workout">
                    <div class="module-icon">üí™</div>
                    <h3 class="module-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
                    <p class="module-desc">–ü—Ä–æ—Å—Ç—ã–µ dropdown —ç–ª–µ–º–µ–Ω—Ç—ã</p>
                    <div class="module-stats">
                        <span class="success-badge">–ê–∫—Ç–∏–≤–Ω–æ</span>
                    </div>
                </div>

                <div class="module-card" data-module="history">
                    <div class="module-icon">üìÖ</div>
                    <h3 class="module-title">–ò—Å—Ç–æ—Ä–∏—è</h3>
                    <p class="module-desc">–†–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è —Å–µ–∫—Ü–∏–∏</p>
                    <div class="module-stats">
                        <span id="total-workouts">3 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</span>
                    </div>
                </div>

                <div class="module-card" data-module="stats">
                    <div class="module-icon">üìä</div>
                    <h3 class="module-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <p class="module-desc">–ü—Ä–æ—Å—Ç—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏</p>
                    <div class="module-stats">
                        <span id="total-tonnage">450 –∫–≥</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workout Module -->
        <div id="workout-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn" onclick="showScreen('main')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 class="screen-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
            </div>

            <div class="workout-content">
                <!-- Date Selector -->
                <div class="date-selector">
                    <button class="date-nav-btn">‚Äπ</button>
                    <div class="date-display">
                        <span>–°–µ–≥–æ–¥–Ω—è</span>
                        <small id="current-date"></small>
                    </div>
                    <button class="date-nav-btn">‚Ä∫</button>
                </div>

                <!-- Workout Stats -->
                <div class="workout-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="workout-tonnage">0</span>
                        <span class="stat-label">–∫–≥</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="workout-reps">0</span>
                        <span class="stat-label">–ø–æ–≤—Ç–æ—Ä–æ–≤</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="workout-max-weight">0</span>
                        <span class="stat-label">–º–∞–∫—Å –≤–µ—Å</span>
                    </div>
                </div>

                <!-- Simple Dropdown Exercise Form -->
                <div class="add-exercise-section">
                    <div class="add-exercise-header">
                        <h3 class="add-exercise-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                    </div>
                    
                    <div class="add-exercise-form">
                        <!-- Exercise Selection Dropdown -->
                        <div class="form-group">
                            <label class="form-label">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
                            <select id="exercise-select" class="form-select">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>
                                <option value="–ñ–∏–º –ª–µ–∂–∞">–ñ–∏–º –ª–µ–∂–∞</option>
                                <option value="–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è">–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è</option>
                                <option value="–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞">–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞</option>
                                <option value="–ñ–∏–º —Å—Ç–æ—è">–ñ–∏–º —Å—Ç–æ—è</option>
                                <option value="–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è">–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è</option>
                                <option value="–û—Ç–∂–∏–º–∞–Ω–∏—è">–û—Ç–∂–∏–º–∞–Ω–∏—è</option>
                                <option value="–ü–ª–∞–Ω–∫–∞">–ü–ª–∞–Ω–∫–∞</option>
                                <option value="–°–≥–∏–±–∞–Ω–∏—è –Ω–∞ –±–∏—Ü–µ–ø—Å">–°–≥–∏–±–∞–Ω–∏—è –Ω–∞ –±–∏—Ü–µ–ø—Å</option>
                                <option value="–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ">–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ</option>
                                <option value="–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º">–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º</option>
                                <option value="–ñ–∏–º –Ω–æ–≥–∞–º–∏">–ñ–∏–º –Ω–æ–≥–∞–º–∏</option>
                                <option value="–†–∞–∑–≤–µ–¥–µ–Ω–∏–µ –≥–∞–Ω—Ç–µ–ª–µ–π">–†–∞–∑–≤–µ–¥–µ–Ω–∏–µ –≥–∞–Ω—Ç–µ–ª–µ–π</option>
                            </select>
                        </div>
                        
                        <!-- Weight Selection Dropdown -->
                        <div class="form-group">
                            <label class="form-label">–í–µ—Å (–∫–≥)</label>
                            <select id="weight-select" class="form-select">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Å</option>
                                <option value="0.5">0.5 –∫–≥</option>
                                <option value="1">1 –∫–≥</option>
                                <option value="2.5">2.5 –∫–≥</option>
                                <option value="5">5 –∫–≥</option>
                                <option value="7.5">7.5 –∫–≥</option>
                                <option value="10">10 –∫–≥</option>
                                <option value="12.5">12.5 –∫–≥</option>
                                <option value="15">15 –∫–≥</option>
                                <option value="20">20 –∫–≥</option>
                                <option value="25">25 –∫–≥</option>
                                <option value="30">30 –∫–≥</option>
                                <option value="40">40 –∫–≥</option>
                                <option value="50">50 –∫–≥</option>
                                <option value="60">60 –∫–≥</option>
                                <option value="70">70 –∫–≥</option>
                                <option value="80">80 –∫–≥</option>
                                <option value="90">90 –∫–≥</option>
                                <option value="100">100 –∫–≥</option>
                                <option value="120">120 –∫–≥</option>
                                <option value="140">140 –∫–≥</option>
                                <option value="160">160 –∫–≥</option>
                                <option value="180">180 –∫–≥</option>
                                <option value="200">200 –∫–≥</option>
                            </select>
                        </div>
                        
                        <!-- Reps Selection Dropdown -->
                        <div class="form-group">
                            <label class="form-label">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</label>
                            <select id="reps-select" class="form-select">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
                                <option value="1">1 –ø–æ–≤—Ç–æ—Ä</option>
                                <option value="2">2 –ø–æ–≤—Ç–æ—Ä–∞</option>
                                <option value="3">3 –ø–æ–≤—Ç–æ—Ä–∞</option>
                                <option value="5">5 –ø–æ–≤—Ç–æ—Ä–æ–≤</option>
                                <option value="6">6 –ø–æ–≤—Ç–æ—Ä–æ–≤</option>
                                <option value="8">8 –ø–æ–≤—Ç–æ—Ä–æ–≤</option>
                                <option value="10">10 –ø–æ–≤—Ç–æ—Ä–æ–≤</option>
                                <option value="12">12 –ø–æ–≤—Ç–æ—Ä–æ–≤</option>
                                <option value="15">15 –ø–æ–≤—Ç–æ—Ä–æ–≤</option>
                                <option value="20">20 –ø–æ–≤—Ç–æ—Ä–æ–≤</option>
                                <option value="25">25 –ø–æ–≤—Ç–æ—Ä–æ–≤</option>
                                <option value="30">30 –ø–æ–≤—Ç–æ—Ä–æ–≤</option>
                                <option value="50">50 –ø–æ–≤—Ç–æ—Ä–æ–≤</option>
                            </select>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="add-exercise-actions">
                            <button id="add-exercise-btn" class="btn-primary" disabled>
                                <span class="btn-icon">üí™</span>
                                –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
                            </button>
                            <button id="add-superset-btn" class="btn-secondary" disabled>
                                <span class="btn-icon">üîó</span>
                                –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—É–ø–µ—Ä—Å–µ—Ç
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Exercises List -->
                <div id="exercises-list" class="exercises-list">
                    <div class="empty-state" id="empty-workout">
                        <div class="empty-icon">üí™</div>
                        <p>–¢–≤–æ–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                        <p class="empty-hint">–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ dropdown –≤—ã—à–µ</p>
                    </div>
                </div>

                <div class="workout-actions">
                    <button id="save-workout-btn" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button id="clear-workout-btn" class="btn btn-danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- History Module -->
        <div id="history-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn" onclick="showScreen('main')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 class="screen-title">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>
            </div>

            <div class="history-content">
                <div class="history-list">
                    <!-- Sample History Items with Expandable Details -->
                    <div class="history-item">
                        <div class="history-header" onclick="toggleDetails(this)">
                            <div class="history-date">–í—á–µ—Ä–∞</div>
                            <div class="history-stats">
                                <span>120 –∫–≥</span>
                                <span>45 –ø–æ–≤—Ç–æ—Ä–æ–≤</span>
                                <span>3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</span>
                            </div>
                            <div class="history-toggle">
                                <span class="toggle-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="history-exercises">
                            –ñ–∏–º –ª–µ–∂–∞, –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è, –°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞
                        </div>
                        <div class="history-details" style="display: none;">
                            <div class="workout-detail-stats">
                                <div class="stat-card">
                                    <div class="stat-value">120</div>
                                    <div class="stat-label">–¢–æ–Ω–Ω–∞–∂ (–∫–≥)</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">45</div>
                                    <div class="stat-label">–ü–æ–≤—Ç–æ—Ä–æ–≤</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">80</div>
                                    <div class="stat-label">–ú–∞–∫—Å –≤–µ—Å (–∫–≥)</div>
                                </div>
                            </div>
                            <div class="workout-detail-exercise">
                                <h4>–ñ–∏–º –ª–µ–∂–∞</h4>
                                <div class="workout-detail-sets">
                                    <div class="workout-detail-set">
                                        <span>–ü–æ–¥—Ö–æ–¥ 1</span>
                                        <span>60 –∫–≥ √ó 10</span>
                                    </div>
                                    <div class="workout-detail-set">
                                        <span>–ü–æ–¥—Ö–æ–¥ 2</span>
                                        <span>80 –∫–≥ √ó 8</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="history-item">
                        <div class="history-header" onclick="toggleDetails(this)">
                            <div class="history-date">3 –¥–Ω—è –Ω–∞–∑–∞–¥</div>
                            <div class="history-stats">
                                <span>95 –∫–≥</span>
                                <span>36 –ø–æ–≤—Ç–æ—Ä–æ–≤</span>
                                <span>2 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</span>
                            </div>
                            <div class="history-toggle">
                                <span class="toggle-icon">‚ñº</span>
                            </div>
                        </div>
                        <div class="history-exercises">
                            –ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è, –û—Ç–∂–∏–º–∞–Ω–∏—è
                        </div>
                        <div class="history-details" style="display: none;">
                            <div class="workout-detail-stats">
                                <div class="stat-card">
                                    <div class="stat-value">95</div>
                                    <div class="stat-label">–¢–æ–Ω–Ω–∞–∂ (–∫–≥)</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">36</div>
                                    <div class="stat-label">–ü–æ–≤—Ç–æ—Ä–æ–≤</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">0</div>
                                    <div class="stat-label">–ú–∞–∫—Å –≤–µ—Å (–∫–≥)</div>
                                </div>
                            </div>
                            <div class="workout-detail-exercise">
                                <h4>–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è</h4>
                                <div class="workout-detail-sets">
                                    <div class="workout-detail-set">
                                        <span>–ü–æ–¥—Ö–æ–¥ 1</span>
                                        <span>–°–≤–æ–π –≤–µ—Å √ó 12</span>
                                    </div>
                                    <div class="workout-detail-set">
                                        <span>–ü–æ–¥—Ö–æ–¥ 2</span>
                                        <span>–°–≤–æ–π –≤–µ—Å √ó 10</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Module -->
        <div id="stats-screen" class="screen">
            <div class="screen-header">
                <button class="back-btn" onclick="showScreen('main')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 class="screen-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            </div>

            <div class="stats-content">
                <!-- Overview Stats -->
                <div class="stats-overview">
                    <div class="stat-card">
                        <div class="stat-value">12</div>
                        <div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">1,450</div>
                        <div class="stat-label">–û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂ (–∫–≥)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">120</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ç–æ–Ω–Ω–∞–∂</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">–°—Ä–µ–¥–∞</div>
                        <div class="stat-label">–õ—É—á—à–∏–π –¥–µ–Ω—å</div>
                    </div>
                </div>

                <!-- Exercise Selector for Charts -->
                <div class="stats-section">
                    <h3 class="section-title">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º</h3>
                    <div class="exercise-selector">
                        <select class="form-select">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</option>
                            <option value="bench_press">–ñ–∏–º –ª–µ–∂–∞</option>
                            <option value="squat">–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è</option>
                            <option value="deadlift">–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞</option>
                            <option value="pullups">–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è</option>
                        </select>
                    </div>
                    <div class="chart-placeholder" style="padding: 40px; text-align: center; background: var(--bg-card); border-radius: var(--radius-xl); margin-top: 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>
                        <p style="font-size: 14px; margin-top: 8px;">–ë–µ–∑ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω - –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced App Controller with Auto-Save Functionality
        let currentScreen = 'main';
        let currentWorkout = [];
        let autosaveTimer = null;
        let lastSaveTime = null;
        let isDirty = false;

        // Storage System with Telegram CloudStorage integration
        const StorageSystem = {
            isCloudStorageAvailable() {
                try {
                    return (
                        typeof window !== 'undefined' &&
                        window.Telegram &&
                        window.Telegram.WebApp &&
                        window.Telegram.WebApp.CloudStorage
                    );
                } catch (error) {
                    console.warn('CloudStorage not available:', error);
                    return false;
                }
            },

            async get(key) {
                console.log(`Getting ${key} from storage...`);
                
                if (this.isCloudStorageAvailable()) {
                    try {
                        const value = await this.getFromCloud(key);
                        console.log(`Got ${key} from CloudStorage:`, value);
                        return value;
                    } catch (error) {
                        console.warn(`CloudStorage failed for ${key}, falling back to localStorage:`, error);
                    }
                }
                
                // Fallback to localStorage
                try {
                    const value = localStorage.getItem(key);
                    const parsed = value ? JSON.parse(value) : null;
                    console.log(`Got ${key} from localStorage:`, parsed);
                    return parsed;
                } catch (error) {
                    console.error(`localStorage failed for ${key}:`, error);
                    return null;
                }
            },

            async set(key, value) {
                console.log(`Saving ${key} to storage:`, value);
                
                if (this.isCloudStorageAvailable()) {
                    try {
                        await this.saveToCloud(key, value);
                        console.log(`Saved ${key} to CloudStorage successfully`);
                        
                        // Also save to localStorage as backup
                        try {
                            localStorage.setItem(key, JSON.stringify(value));
                        } catch (localError) {
                            console.warn('Failed to backup to localStorage:', localError);
                        }
                        
                        return true;
                    } catch (error) {
                        console.warn(`CloudStorage failed for ${key}, falling back to localStorage:`, error);
                    }
                }
                
                // Fallback to localStorage
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    console.log(`Saved ${key} to localStorage successfully`);
                    return true;
                } catch (error) {
                    console.error(`localStorage failed for ${key}:`, error);
                    throw error;
                }
            },

            getFromCloud(key) {
                return new Promise((resolve, reject) => {
                    window.Telegram.WebApp.CloudStorage.getItem(key, (error, value) => {
                        if (error) {
                            reject(new Error(error));
                        } else {
                            try {
                                resolve(value ? JSON.parse(value) : null);
                            } catch (parseError) {
                                console.error(`Failed to parse ${key}:`, parseError);
                                resolve(null);
                            }
                        }
                    });
                });
            },

            saveToCloud(key, value) {
                return new Promise((resolve, reject) => {
                    const serialized = JSON.stringify(value);
                    window.Telegram.WebApp.CloudStorage.setItem(key, serialized, (error, success) => {
                        if (error) {
                            reject(new Error(error));
                        } else {
                            resolve(success);
                        }
                    });
                });
            }
        };

        // Auto-save functionality
        function startAutosave() {
            console.log('Starting autosave timer...');
            
            if (autosaveTimer) {
                clearInterval(autosaveTimer);
            }
            
            autosaveTimer = setInterval(async () => {
                if (isDirty && currentWorkout.length > 0) {
                    await saveDraft();
                }
            }, 30000); // 30 seconds
        }

        async function saveDraft() {
            if (currentWorkout.length === 0) {
                console.log('No workout data to save');
                return;
            }

            console.log('Saving draft workout...');
            showSaveStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'saving');
            
            try {
                const draftData = {
                    exercises: currentWorkout,
                    date: new Date().toISOString(),
                    stats: getCurrentWorkoutStats()
                };
                
                await StorageSystem.set('draftWorkout', draftData);
                lastSaveTime = new Date();
                isDirty = false;
                
                console.log('Draft saved successfully:', draftData);
                showSaveStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
                
                // Hide save status after 2 seconds
                setTimeout(() => hideSaveStatus(), 2000);
                
            } catch (error) {
                console.error('Failed to save draft:', error);
                showSaveStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                setTimeout(() => hideSaveStatus(), 3000);
            }
        }

        async function loadDraft() {
            console.log('Loading draft workout...');
            
            try {
                const draftData = await StorageSystem.get('draftWorkout');
                
                if (draftData) {
                    const draftDate = new Date(draftData.date);
                    const today = new Date();
                    const isToday = draftDate.toDateString() === today.toDateString();
                    
                    if (isToday && draftData.exercises && draftData.exercises.length > 0) {
                        console.log('Found draft for today:', draftData);
                        
                        // Show draft recovery notification
                        showDraftRecovery(draftData);
                        return draftData;
                    } else if (!isToday) {
                        console.log('Draft is from different day, clearing it');
                        await StorageSystem.set('draftWorkout', null);
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Failed to load draft:', error);
                return null;
            }
        }

        function showDraftRecovery(draftData) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-card, #1e1e1e);
                border: 1px solid var(--border-glass, #333);
                border-radius: 16px;
                padding: 24px;
                max-width: 300px;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            `;
            
            modal.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 16px;">üîÑ</div>
                <h3 style="color: var(--text-primary, #fff); margin-bottom: 12px;">–ù–∞–π–¥–µ–Ω —á–µ—Ä–Ω–æ–≤–∏–∫</h3>
                <p style="color: var(--text-secondary, #aaa); margin-bottom: 20px;">
                    –ù–∞–π–¥–µ–Ω–∞ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å ${draftData.exercises.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏
                </p>
                <div style="display: flex; gap: 12px;">
                    <button id="restore-draft" style="
                        background: var(--success-color, #4CAF50);
                        color: white;
                        border: none;
                        padding: 12px 16px;
                        border-radius: 8px;
                        cursor: pointer;
                        flex: 1;
                    ">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button id="start-new" style="
                        background: var(--bg-glass, #333);
                        color: var(--text-primary, #fff);
                        border: 1px solid var(--border-glass, #555);
                        padding: 12px 16px;
                        border-radius: 8px;
                        cursor: pointer;
                        flex: 1;
                    ">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Handle buttons
            document.getElementById('restore-draft').onclick = () => {
                currentWorkout = draftData.exercises || [];
                updateWorkoutStats();
                renderExercises();
                document.body.removeChild(overlay);
                showSaveStatus('–ß–µ—Ä–Ω–æ–≤–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
                setTimeout(() => hideSaveStatus(), 2000);
            };
            
            document.getElementById('start-new').onclick = () => {
                StorageSystem.set('draftWorkout', null); // Clear draft
                document.body.removeChild(overlay);
            };
        }

        function getCurrentWorkoutStats() {
            let totalTonnage = 0;
            let totalReps = 0;
            let maxWeight = 0;

            currentWorkout.forEach(exercise => {
                const weight = parseFloat(exercise.weight) || 0;
                const reps = parseInt(exercise.reps) || 0;
                
                totalTonnage += weight * reps;
                totalReps += reps;
                maxWeight = Math.max(maxWeight, weight);
            });

            return {
                tonnage: Math.round(totalTonnage),
                reps: totalReps,
                maxWeight: Math.round(maxWeight)
            };
        }

        function showSaveStatus(message, type = 'info') {
            let statusEl = document.getElementById('save-status');
            
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'save-status';
                statusEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 16px;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    z-index: 1000;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;
                document.body.appendChild(statusEl);
            }
            
            const colors = {
                saving: '#FFA726',
                success: '#4CAF50',
                error: '#F44336',
                info: '#2196F3'
            };
            
            const icons = {
                saving: '‚è≥',
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è'
            };
            
            statusEl.style.backgroundColor = colors[type] || colors.info;
            statusEl.innerHTML = `${icons[type] || icons.info} ${message}`;
            statusEl.style.opacity = '1';
            statusEl.style.transform = 'translateX(0)';
        }

        function hideSaveStatus() {
            const statusEl = document.getElementById('save-status');
            if (statusEl) {
                statusEl.style.opacity = '0';
                statusEl.style.transform = 'translateX(100%)';
            }
        }

        function markDirty() {
            isDirty = true;
        }

        // Initialize current date
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('ru-RU');

        // Screen Navigation
        function showScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show target screen
            const targetScreen = document.getElementById(screenName + '-screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
                currentScreen = screenName;
                
                // Update Telegram WebApp UI
                updateTelegramUI();
            }
        }

        // Module card clicks
        document.querySelectorAll('.module-card').forEach(card => {
            card.addEventListener('click', function() {
                const module = this.dataset.module;
                if (module) {
                    showScreen(module);
                }
            });
        });

        // Initialize Telegram WebApp
        async function initTelegramWebApp() {
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                
                console.log('Initializing Telegram WebApp...');
                
                // Configure WebApp
                tg.ready();
                tg.expand();
                
                // Set theme
                if (tg.colorScheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                
                // Handle back button
                tg.BackButton.onClick(() => {
                    if (currentScreen !== 'main') {
                        showScreen('main');
                    }
                });
                
                // Handle main button (save workout)
                tg.MainButton.onClick(async () => {
                    if (currentScreen === 'workout' && currentWorkout.length > 0) {
                        await saveCompleteWorkout();
                    }
                });
                
                console.log('Telegram WebApp initialized');
                return true;
            } else {
                console.warn('Telegram WebApp not available - running in web mode');
                return false;
            }
        }

        // Save completed workout
        async function saveCompleteWorkout() {
            if (currentWorkout.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ');
                return;
            }
            
            showSaveStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...', 'saving');
            
            try {
                // Prepare workout data
                const workoutData = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    exercises: currentWorkout,
                    stats: getCurrentWorkoutStats(),
                    duration: 0 // TODO: Track workout duration
                };
                
                // Load existing workouts
                const existingWorkouts = await StorageSystem.get('workouts') || [];
                existingWorkouts.push(workoutData);
                
                // Save workouts
                await StorageSystem.set('workouts', existingWorkouts);
                
                // Clear draft
                await StorageSystem.set('draftWorkout', null);
                
                // Reset current workout
                currentWorkout = [];
                isDirty = false;
                updateWorkoutStats();
                renderExercises();
                
                showSaveStatus('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                
                // Show success message
                alert(`–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!\n${workoutData.exercises.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π\n–¢–æ–Ω–Ω–∞–∂: ${workoutData.stats.tonnage} –∫–≥`);
                
                // Hide save status after showing alert
                setTimeout(() => hideSaveStatus(), 2000);
                
            } catch (error) {
                console.error('Failed to save workout:', error);
                showSaveStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');
                setTimeout(() => hideSaveStatus(), 3000);
            }
        }

        // Handle app lifecycle events
        let lifecycleHandlersSetup = false;
        function setupLifecycleHandlers() {
            if (lifecycleHandlersSetup) return;
            
            // Save draft on visibility change
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && isDirty && currentWorkout.length > 0) {
                    console.log('App hidden, saving draft...');
                    saveDraft();
                }
            });
            
            // Save draft before unload
            window.addEventListener('beforeunload', (event) => {
                if (isDirty && currentWorkout.length > 0) {
                    saveDraft();
                    event.preventDefault();
                    event.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?';
                    return event.returnValue;
                }
            });
            
            // Handle pagehide (iOS Safari)
            window.addEventListener('pagehide', () => {
                if (isDirty && currentWorkout.length > 0) {
                    saveDraft();
                }
            });
            
            lifecycleHandlersSetup = true;
        }

        // Update Telegram WebApp UI
        function updateTelegramUI() {
            if (!window.Telegram?.WebApp) return;
            
            const tg = window.Telegram.WebApp;
            
            // Update back button based on current screen
            if (currentScreen === 'main') {
                tg.BackButton.hide();
            } else {
                tg.BackButton.show();
            }
            
            // Update main button for workout screen
            if (currentScreen === 'workout') {
                if (currentWorkout.length > 0) {
                    tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É');
                    tg.MainButton.color = '#4CAF50';
                    tg.MainButton.textColor = '#FFFFFF';
                    tg.MainButton.show();
                } else {
                    tg.MainButton.hide();
                }
            } else {
                tg.MainButton.hide();
            }
        }

        // Exercise Form Logic
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded, initializing app...');
            
            // Initialize Telegram WebApp
            await initTelegramWebApp();
            
            // Setup lifecycle handlers
            setupLifecycleHandlers();
            
            // Start autosave
            startAutosave();
            
            // Load draft workout
            await loadDraft();
            
            console.log('App initialization complete');
            
            const exerciseSelect = document.getElementById('exercise-select');
            const weightSelect = document.getElementById('weight-select');
            const repsSelect = document.getElementById('reps-select');
            const addBtn = document.getElementById('add-exercise-btn');
            const supersetBtn = document.getElementById('add-superset-btn');
            const exercisesList = document.getElementById('exercises-list');
            const emptyWorkout = document.getElementById('empty-workout');

            function updateButtons() {
                const hasExercise = exerciseSelect.value;
                const hasWeight = weightSelect.value;
                const hasReps = repsSelect.value;
                const isValid = hasExercise && (hasWeight || hasReps);
                
                addBtn.disabled = !isValid;
                supersetBtn.disabled = !isValid;
            }

            function resetForm() {
                exerciseSelect.value = '';
                weightSelect.value = '';
                repsSelect.value = '';
                updateButtons();
            }

            function updateWorkoutStats() {
                let totalTonnage = 0;
                let totalReps = 0;
                let maxWeight = 0;

                currentWorkout.forEach(exercise => {
                    const weight = parseFloat(exercise.weight) || 0;
                    const reps = parseInt(exercise.reps) || 0;
                    
                    totalTonnage += weight * reps;
                    totalReps += reps;
                    maxWeight = Math.max(maxWeight, weight);
                });

                document.getElementById('workout-tonnage').textContent = Math.round(totalTonnage);
                document.getElementById('workout-reps').textContent = totalReps;
                document.getElementById('workout-max-weight').textContent = Math.round(maxWeight);
                
                // Update Telegram WebApp buttons
                updateTelegramUI();
            }

            function renderExercises() {
                if (currentWorkout.length === 0) {
                    emptyWorkout.style.display = 'flex';
                    return;
                }

                emptyWorkout.style.display = 'none';
                
                const exercisesHtml = currentWorkout.map((exercise, index) => `
                    <div class="exercise-item" style="background: var(--bg-card); border: 1px solid var(--border-glass); border-radius: var(--radius-xl); padding: var(--spacing-lg); margin-bottom: var(--spacing-md); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="color: var(--text-primary); margin-bottom: 8px;">${exercise.name}</h4>
                            <p style="color: var(--text-secondary); font-size: 14px;">${exercise.weight} –∫–≥ √ó ${exercise.reps} –ø–æ–≤—Ç–æ—Ä–æ–≤</p>
                        </div>
                        <button onclick="removeExercise(${index})" style="background: var(--bg-glass); border: 1px solid var(--border-glass); border-radius: var(--radius-md); padding: 8px; color: var(--text-secondary); cursor: pointer;">üóëÔ∏è</button>
                    </div>
                `).join('');

                exercisesList.innerHTML = exercisesHtml;
            }

            exerciseSelect.addEventListener('change', updateButtons);
            weightSelect.addEventListener('change', updateButtons);
            repsSelect.addEventListener('change', updateButtons);

            addBtn.addEventListener('click', function() {
                const exercise = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    name: exerciseSelect.value,
                    weight: parseFloat(weightSelect.value) || 0,
                    reps: parseInt(repsSelect.value) || 0,
                    addedAt: new Date().toISOString()
                };
                
                currentWorkout.push(exercise);
                markDirty(); // Mark workout as dirty for autosave
                updateWorkoutStats();
                renderExercises();
                resetForm();
                
                console.log('Exercise added:', exercise);
                
                // Success feedback
                const originalText = addBtn.innerHTML;
                addBtn.innerHTML = '<span class="btn-icon">‚úÖ</span>–î–æ–±–∞–≤–ª–µ–Ω–æ!';
                addBtn.style.background = 'var(--success-color)';
                
                setTimeout(() => {
                    addBtn.innerHTML = originalText;
                    addBtn.style.background = '';
                }, 1000);
            });

            supersetBtn.addEventListener('click', function() {
                const exercise = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    name: exerciseSelect.value + ' (—Å—É–ø–µ—Ä—Å–µ—Ç)',
                    weight: parseFloat(weightSelect.value) || 0,
                    reps: parseInt(repsSelect.value) || 0,
                    isSuperset: true,
                    addedAt: new Date().toISOString()
                };
                
                currentWorkout.push(exercise);
                markDirty(); // Mark workout as dirty for autosave
                updateWorkoutStats();
                renderExercises();
                resetForm();
                
                console.log('Superset exercise added:', exercise);
                
                // Success feedback
                const originalText = supersetBtn.innerHTML;
                supersetBtn.innerHTML = '<span class="btn-icon">‚úÖ</span>–î–æ–±–∞–≤–ª–µ–Ω–æ!';
                supersetBtn.style.background = 'var(--success-color)';
                
                setTimeout(() => {
                    supersetBtn.innerHTML = originalText;
                    supersetBtn.style.background = '';
                }, 1000);
            });

            // Clear workout
            document.getElementById('clear-workout-btn').addEventListener('click', async function() {
                if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                    currentWorkout = [];
                    isDirty = false;
                    updateWorkoutStats();
                    renderExercises();
                    
                    // Clear draft
                    try {
                        await StorageSystem.set('draftWorkout', null);
                        showSaveStatus('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
                        setTimeout(() => hideSaveStatus(), 2000);
                    } catch (error) {
                        console.error('Failed to clear draft:', error);
                    }
                }
            });

            // Save workout
            document.getElementById('save-workout-btn').addEventListener('click', async function() {
                await saveCompleteWorkout();
            });

            updateButtons();
        });

        // History toggle function
        function toggleDetails(header) {
            const item = header.closest('.history-item');
            const details = item.querySelector('.history-details');
            const icon = item.querySelector('.toggle-icon');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.textContent = '‚ñ≤';
                item.classList.add('expanded');
            } else {
                details.style.display = 'none';
                icon.textContent = '‚ñº';
                item.classList.remove('expanded');
            }
        }

        // Remove exercise function
        function removeExercise(index) {
            console.log('Removing exercise at index:', index);
            currentWorkout.splice(index, 1);
            markDirty(); // Mark workout as dirty for autosave
            updateWorkoutStats();
            renderExercises();
        }
    </script>
</body>
</html>
